@page "/agent-wizard"
@page "/agent-wizard/{TemplateId:int}"
@using DocN.Data.Models
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>üßô Configurazione Guidata Agente AI - DocN</PageTitle>

<div class="wizard-container">
    @if (isLoading)
    {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Caricamento...</p>
        </div>
    }
    else
    {
        <!-- Wizard Header -->
        <div class="wizard-header">
            <h1>üßô‚Äç‚ôÇÔ∏è Configurazione Guidata Agente AI</h1>
            <p class="subtitle">Crea il tuo assistente AI personalizzato in pochi semplici passaggi - non serve essere un esperto!</p>
        </div>

        <!-- Progress Steps -->
        <div class="wizard-steps">
            <div class="step @(currentStep == 1 ? "active" : "") @(currentStep > 1 ? "completed" : "")">
                <div class="step-number">1</div>
                <div class="step-label">Scegli Tipo</div>
            </div>
            <div class="step-connector"></div>
            <div class="step @(currentStep == 2 ? "active" : "") @(currentStep > 2 ? "completed" : "")">
                <div class="step-number">2</div>
                <div class="step-label">Configura Provider</div>
            </div>
            <div class="step-connector"></div>
            <div class="step @(currentStep == 3 ? "active" : "") @(currentStep > 3 ? "completed" : "")">
                <div class="step-number">3</div>
                <div class="step-label">Personalizza</div>
            </div>
            <div class="step-connector"></div>
            <div class="step @(currentStep == 4 ? "active" : "") @(currentStep > 4 ? "completed" : "")">
                <div class="step-number">4</div>
                <div class="step-label">Testa</div>
            </div>
            <div class="step-connector"></div>
            <div class="step @(currentStep == 5 ? "active" : "") @(currentStep > 5 ? "completed" : "")">
                <div class="step-number">5</div>
                <div class="step-label">Completa</div>
            </div>
        </div>

        <!-- Wizard Content -->
        <div class="wizard-content">
            @if (currentStep == 1)
            {
                <Step1_ChooseTemplate 
                    Templates="@templates" 
                    SelectedTemplate="@selectedTemplate"
                    OnTemplateSelected="SelectTemplate"
                    OnNext="NextStep" />
            }
            else if (currentStep == 2)
            {
                <Step2_ConfigureProvider 
                    Agent="@agentConfig"
                    OnBack="PreviousStep"
                    OnNext="NextStep" />
            }
            else if (currentStep == 3)
            {
                <Step3_Customize 
                    Agent="@agentConfig"
                    OnBack="PreviousStep"
                    OnNext="NextStep" />
            }
            else if (currentStep == 4)
            {
                <Step4_Test 
                    Agent="@agentConfig"
                    OnBack="PreviousStep"
                    OnNext="NextStep" />
            }
            else if (currentStep == 5)
            {
                <Step5_Complete 
                    Agent="@agentConfig"
                    OnBack="PreviousStep"
                    OnSave="SaveAgent" />
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int? TemplateId { get; set; }

    private int currentStep = 1;
    private bool isLoading = true;
    private List<AgentTemplate> templates = new();
    private AgentTemplate? selectedTemplate;
    private AgentConfiguration agentConfig = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        
        // If template ID provided, pre-select it
        if (TemplateId.HasValue)
        {
            selectedTemplate = templates.FirstOrDefault(t => t.Id == TemplateId.Value);
            if (selectedTemplate != null)
            {
                await SelectTemplate(selectedTemplate);
            }
        }
        
        isLoading = false;
    }

    private async Task LoadTemplates()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("DocN.ServerAPI");
            templates = await client.GetFromJsonAsync<List<AgentTemplate>>("api/agent/templates") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Errore caricamento template: {ex.Message}");
        }
    }

    private async Task SelectTemplate(AgentTemplate template)
    {
        selectedTemplate = template;
        
        try
        {
            var client = HttpClientFactory.CreateClient("DocN.ServerAPI");
            agentConfig = await client.PostAsync($"api/agent/create-from-template/{template.Id}", null)
                .Result.Content.ReadFromJsonAsync<AgentConfiguration>() ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Errore creazione agente: {ex.Message}");
        }
    }

    private void NextStep()
    {
        if (currentStep < 5)
        {
            currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }

    private async Task SaveAgent()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("DocN.ServerAPI");
            var response = await client.PutAsJsonAsync($"api/agent/{agentConfig.Id}", agentConfig);
            
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "‚úÖ Agente salvato con successo!");
                Navigation.NavigateTo("/agents");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "‚ùå Errore nel salvataggio dell'agente");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Errore: {ex.Message}");
        }
    }
}

<style>
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .wizard-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .wizard-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .subtitle {
        font-size: 1.1rem;
        color: #7f8c8d;
    }

    .wizard-steps {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 3rem;
        padding: 0 2rem;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .step.active .step-number {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .step.completed .step-number {
        background: #27ae60;
        color: white;
    }

    .step-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        font-weight: 500;
    }

    .step.active .step-label {
        color: #667eea;
        font-weight: 600;
    }

    .step-connector {
        flex: 1;
        height: 3px;
        background: #e0e0e0;
        margin: 0 1rem;
        max-width: 100px;
    }

    .wizard-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 20px rgba(0,0,0,0.08);
    }

    .loading-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
