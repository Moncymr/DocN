@page "/chat"
@using System.Net.Http.Json
@using System.Text.Json
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Document Chat - DocN</PageTitle>

<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="header-left">
            <div class="chat-icon">üí¨</div>
            <div class="header-info">
                <h1>Document Chat</h1>
                <p class="subtitle">Ask questions about your uploaded documents</p>
            </div>
        </div>
        <div class="header-right">
            @if (currentConversationId.HasValue)
            {
                <button class="btn-new-chat" @onclick="StartNewConversation">
                    ‚ûï New Chat
                </button>
            }
            <button class="btn-toggle-sidebar" @onclick="ToggleSidebar">
                ‚ò∞
            </button>
        </div>
    </div>

    <div class="chat-content">
        <!-- Sidebar with Conversations -->
        <div class="chat-sidebar @(showSidebar ? "open" : "")">
            <div class="sidebar-header">
                <h3>üìö Conversations</h3>
            </div>
            <div class="conversations-list">
                @if (isLoadingConversations)
                {
                    <div class="loading-conversations">Loading...</div>
                }
                else if (conversations.Any())
                {
                    @foreach (var conv in conversations)
                    {
                        <div class="conversation-item @(conv.Id == currentConversationId ? "active" : "")"
                             @onclick="() => LoadConversation(conv.Id)">
                            <div class="conversation-title">@conv.Title</div>
                            <div class="conversation-meta">
                                <span>üí¨ @conv.MessageCount</span>
                                <span>@FormatDate(conv.LastMessageAt)</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-conversations">
                        <p>No conversations yet</p>
                        <p class="hint">Start chatting to create one!</p>
                    </div>
                }
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Messages Area -->
            <div class="messages-container" @ref="messagesContainer">
                @if (!messages.Any() && !currentConversationId.HasValue)
                {
                    <!-- Welcome Screen -->
                    <div class="welcome-screen">
                        <div class="welcome-icon">ü§ñ</div>
                        <h2>Welcome to Document Chat</h2>
                        <p>Ask me anything about your uploaded documents!</p>
                    </div>
                }
                else
                {
                    @foreach (var msg in messages)
                    {
                        <div class="message @msg.Role">
                            <div class="message-avatar">
                                @if (msg.Role == "user")
                                {
                                    <span>üë§</span>
                                }
                                else
                                {
                                    <span>ü§ñ</span>
                                }
                            </div>
                            <div class="message-content">
                                <div class="message-text">@msg.Content</div>
                                @if (msg.ReferencedDocumentIds.Any())
                                {
                                    <div class="message-sources">
                                        <span class="sources-label">üìö Sources:</span>
                                        @foreach (var docId in msg.ReferencedDocumentIds)
                                        {
                                            <span class="source-tag">Document #@docId</span>
                                        }
                                    </div>
                                }
                                <div class="message-time">@msg.Timestamp.ToString("HH:mm")</div>
                            </div>
                        </div>
                    }
                }

                @if (isProcessing)
                {
                    <div class="message assistant">
                        <div class="message-avatar">
                            <span>ü§ñ</span>
                        </div>
                        <div class="message-content">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Input Area -->
            <div class="chat-input-area">
                @if (errorMessage != null)
                {
                    <div class="error-banner">
                        <span>‚ö†Ô∏è @errorMessage</span>
                        <button @onclick="ClearError">‚úï</button>
                    </div>
                }
                <div class="input-container">
                    <textarea 
                        class="chat-input" 
                        placeholder="Ask a question about your documents..."
                        @bind="userQuery"
                        @onkeydown="HandleKeyDown"
                        rows="1"
                        disabled="@isProcessing"></textarea>
                    <button class="btn-send" @onclick="SendMessage" disabled="@(isProcessing || string.IsNullOrWhiteSpace(userQuery))">
                        @if (isProcessing)
                        {
                            <span class="spinner-small"></span>
                        }
                        else
                        {
                            <span>üì§</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    /* Header */
    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        z-index: 10;
        border-radius: 15px;
        margin: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-icon {
        font-size: 2rem;
    }

    .header-info h1 {
        font-size: 1.5rem;
        margin: 0;
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #666;
        font-size: 0.9rem;
        margin: 0.25rem 0 0 0;
    }

    .header-right {
        display: flex;
        gap: 1rem;
    }

    .btn-new-chat, .btn-toggle-sidebar {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .btn-docs {
        background: white;
        color: #ff6b35;
        border: 1px solid #ff6b35;
    }

    .btn-docs:hover {
        background: #ff6b35;
        color: white;
    }

    .btn-new-chat {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-new-chat:hover {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }

    .btn-toggle-sidebar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #333;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .btn-toggle-sidebar:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Content Area */
    .chat-content {
        display: flex;
        flex: 1;
        overflow: hidden;
        margin: 0 1rem 1rem 1rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Sidebar */
    .chat-sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s;
        border-radius: 15px 0 0 15px;
    }

    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-header h3 {
        font-size: 1.2rem;
        color: #333;
    }

    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .conversation-item {
        padding: 0.75rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 10px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .conversation-item:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-color: rgba(255, 107, 53, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .conversation-item.active {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .conversation-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .conversation-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .empty-conversations {
        text-align: center;
        padding: 3rem 1rem;
        color: #999;
    }

    .empty-conversations .hint {
        font-size: 0.85rem;
        margin-top: 0.5rem;
    }

    /* Main Chat Area */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: white;
        border-radius: 0 15px 15px 0;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        scroll-behavior: smooth;
    }

    /* Welcome Screen */
    .welcome-screen {
        text-align: center;
        padding: 3rem 2rem;
        max-width: 600px;
        margin: 0 auto;
    }

    .welcome-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .welcome-screen h2 {
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 1.5rem;
    }

    .welcome-screen p {
        color: #666;
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Messages */
    .message {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .message-content {
        max-width: 70%;
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .message.user .message-content {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
    }

    .message-text {
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .message-sources {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .message.user .message-sources {
        border-top-color: rgba(255,255,255,0.3);
    }

    .sources-label {
        font-size: 0.85rem;
        font-weight: 600;
    }

    .source-tag {
        background: #fff5f2;
        color: #ff6b35;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .message.user .source-tag {
        background: rgba(255,255,255,0.2);
        color: white;
    }

    .message-time {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        opacity: 0.7;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #ff6b35;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @@keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Input Area */
    .chat-input-area {
        background: white;
        padding: 1.5rem 2rem;
        border-top: 1px solid #e0e0e0;
    }

    .error-banner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8d7da;
        color: #721c24;
        padding: 0.75rem 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        border: 1px solid #f5c6cb;
    }

    .error-banner button {
        background: none;
        border: none;
        color: #721c24;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .input-container {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        resize: none;
        max-height: 150px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }

    .chat-input:focus {
        outline: none;
        border-color: #ff6b35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        background: white;
    }

    .chat-input:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
    }

    .btn-send {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
    }

    .btn-send:hover:not(:disabled) {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
    }

    .btn-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .spinner-small {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Loading */
    .loading-conversations {
        text-align: center;
        padding: 2rem;
        color: #999;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .chat-sidebar {
            position: absolute;
            left: -300px;
            height: 100%;
            z-index: 20;
        }

        .chat-sidebar.open {
            transform: translateX(300px);
        }

        .message-content {
            max-width: 85%;
        }

        .chat-input-area {
            padding: 1rem;
        }
    }
</style>

@code {
    private ElementReference messagesContainer;
    private List<ConversationSummary> conversations = new();
    private List<ConversationMessage> messages = new();
    private int? currentConversationId = null;
    private string userQuery = string.Empty;
    private string currentUserId = string.Empty;
    private bool isProcessing = false;
    private bool isLoadingConversations = false;
    private bool showSidebar = true;
    private string? errorMessage = null;
    private HttpClient? _httpClient;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "demo-user";
        
        // Create HttpClient instance
        _httpClient = HttpClientFactory.CreateClient("BackendAPI");
        
        await LoadConversations();
    }

    private async Task LoadConversations()
    {
        if (_httpClient == null) return;
        
        isLoadingConversations = true;
        errorMessage = null;
        try
        {
            var response = await _httpClient.GetFromJsonAsync<List<ConversationSummary>>(
                $"api/SemanticChat/conversations?userId={currentUserId}");
            
            if (response != null)
            {
                conversations = response;
            }
        }
        catch (HttpRequestException ex)
        {
            // Connection to backend API failed
            errorMessage = "‚ö†Ô∏è Unable to connect to the backend service. Please ensure the DocN.Server is running on https://localhost:5211. " +
                          "See README.md for setup instructions.";
            Console.WriteLine($"Backend API connection error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load conversations: {ex.Message}";
            Console.WriteLine($"Error loading conversations: {ex}");
        }
        finally
        {
            isLoadingConversations = false;
        }
    }

    private async Task LoadConversation(int conversationId)
    {
        if (_httpClient == null) return;
        
        errorMessage = null;
        try
        {
            var response = await _httpClient.GetFromJsonAsync<ConversationMessagesResponse>(
                $"api/SemanticChat/conversations/{conversationId}/messages");
            
            if (response != null)
            {
                currentConversationId = conversationId;
                messages = response.Messages;
                await ScrollToBottom();
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "‚ö†Ô∏è Unable to connect to the backend service. Please ensure the DocN.Server is running on https://localhost:5211.";
            Console.WriteLine($"Backend API connection error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load conversation: {ex.Message}";
            Console.WriteLine($"Error loading conversation: {ex}");
        }
    }

    private async Task SendMessage()
    {
        if (_httpClient == null || string.IsNullOrWhiteSpace(userQuery) || isProcessing)
            return;

        var query = userQuery.Trim();
        userQuery = string.Empty;
        errorMessage = null;
        isProcessing = true;

        try
        {
            // Add user message to UI immediately
            messages.Add(new ConversationMessage
            {
                Role = "user",
                Content = query,
                Timestamp = DateTime.UtcNow
            });

            await ScrollToBottom();
            StateHasChanged();

            // Send to API
            var request = new SemanticChatRequest
            {
                Message = query,
                UserId = currentUserId,
                ConversationId = currentConversationId
            };

            var response = await _httpClient.PostAsJsonAsync("api/SemanticChat/query", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SemanticChatResponse>();
                
                if (result != null)
                {
                    // Add assistant message
                    messages.Add(new ConversationMessage
                    {
                        Role = "assistant",
                        Content = result.Answer,
                        Timestamp = DateTime.UtcNow,
                        ReferencedDocumentIds = result.SourceDocuments.Select(d => d.DocumentId).ToList()
                    });

                    currentConversationId = result.ConversationId;

                    // Reload conversations list
                    await LoadConversations();
                }
            }
            else
            {
                // Handle error responses
                try
                {
                    var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                    if (errorResponse?.ErrorCode == "AI_PROVIDER_NOT_CONFIGURED")
                    {
                        errorMessage = "üîß AI Configuration Required: No AI provider is configured. " +
                                      "Please go to Settings and configure at least one AI provider (Gemini, OpenAI, or Azure OpenAI) to use the chat feature.";
                    }
                    else
                    {
                        errorMessage = $"‚ö†Ô∏è {errorResponse?.Error ?? "An error occurred while processing your request."}";
                    }
                }
                catch
                {
                    errorMessage = $"‚ö†Ô∏è Server error ({(int)response.StatusCode}): {response.ReasonPhrase}";
                }
                
                Console.WriteLine($"API error: {response.StatusCode}");
                
                // Remove the user message since it wasn't sent successfully
                if (messages.Any() && messages.Last().Role == "user")
                {
                    messages.RemoveAt(messages.Count - 1);
                }
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "‚ö†Ô∏è Unable to connect to the backend service. Please ensure the DocN.Server is running on https://localhost:5211.";
            Console.WriteLine($"Backend API connection error: {ex.Message}");
            
            // Remove the user message since it wasn't sent successfully
            if (messages.Any() && messages.Last().Role == "user")
            {
                messages.RemoveAt(messages.Count - 1);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"‚ö†Ô∏è Error sending message: {ex.Message}";
            Console.WriteLine($"Error sending message: {ex}");
            
            // Remove the user message since it wasn't sent successfully
            if (messages.Any() && messages.Last().Role == "user")
            {
                messages.RemoveAt(messages.Count - 1);
            }
        }
        finally
        {
            isProcessing = false;
            await ScrollToBottom();
            StateHasChanged();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void StartNewConversation()
    {
        currentConversationId = null;
        messages.Clear();
        userQuery = string.Empty;
        errorMessage = null;
    }

    private void ToggleSidebar()
    {
        showSidebar = !showSidebar;
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(100);
        // JS interop would be needed for actual scrolling
        StateHasChanged();
    }

    private string FormatDate(DateTime date)
    {
        var now = DateTime.UtcNow;
        var diff = now - date;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalHours < 1)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalDays < 1)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        
        return date.ToString("MMM dd");
    }

    // Request/Response models (matching the API)
    public class SemanticChatRequest
    {
        public string Message { get; set; } = string.Empty;
        public string UserId { get; set; } = string.Empty;
        public int? ConversationId { get; set; }
        public List<int>? SpecificDocumentIds { get; set; }
        public int TopK { get; set; } = 5;
    }

    public class SemanticChatResponse
    {
        public int ConversationId { get; set; }
        public string Answer { get; set; } = string.Empty;
        public List<DocumentReference> SourceDocuments { get; set; } = new();
        public long ResponseTimeMs { get; set; }
        public bool FromCache { get; set; }
        public Dictionary<string, object> Metadata { get; set; } = new();
    }

    public class ErrorResponse
    {
        public string Error { get; set; } = string.Empty;
        public string? ErrorCode { get; set; }
        public string? Details { get; set; }
    }

    public class DocumentReference
    {
        public int DocumentId { get; set; }
        public string FileName { get; set; } = string.Empty;
        public string? Category { get; set; }
        public double SimilarityScore { get; set; }
        public string? RelevantChunk { get; set; }
        public int? ChunkIndex { get; set; }
    }

    public class ConversationSummary
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public DateTime LastMessageAt { get; set; }
        public int MessageCount { get; set; }
        public bool IsStarred { get; set; }
    }

    public class ConversationMessage
    {
        public int Id { get; set; }
        public string Role { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public List<int> ReferencedDocumentIds { get; set; } = new();
    }

    public class ConversationMessagesResponse
    {
        public int ConversationId { get; set; }
        public string Title { get; set; } = string.Empty;
        public List<ConversationMessage> Messages { get; set; } = new();
    }
}
