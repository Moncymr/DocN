@page "/search"
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>Search - DocN</PageTitle>

<div class="search-page">
    <!-- Header -->
    <div class="page-header">
        <h1>üîç Document Search</h1>
        <p class="subtitle">Search your documents using vector similarity, full-text, or hybrid search</p>
    </div>

    <!-- Search Box -->
    <div class="search-container">
        <div class="search-input-group">
            <input type="text" 
                   class="search-input-large" 
                   placeholder="Enter your search query..."
                   @bind="searchQuery"
                   @onkeyup="HandleKeyPress" />
            <button class="btn-search" @onclick="PerformSearch" disabled="@isSearching">
                @if (isSearching)
                {
                    <span class="spinner-small"></span>
                }
                else
                {
                    <span>üîç Search</span>
                }
            </button>
        </div>

        <!-- Search Type Selector -->
        <div class="search-type-selector">
            <button class="type-btn @(searchType == "hybrid" ? "active" : "")" 
                    @onclick='() => SetSearchType("hybrid")'>
                ‚ö° Hybrid Search
                <small>Best results</small>
            </button>
            <button class="type-btn @(searchType == "vector" ? "active" : "")" 
                    @onclick='() => SetSearchType("vector")'>
                üß† Vector Search
                <small>Semantic similarity</small>
            </button>
            <button class="type-btn @(searchType == "text" ? "active" : "")" 
                    @onclick='() => SetSearchType("text")'>
                üìù Text Search
                <small>Keyword matching</small>
            </button>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters">
            <details>
                <summary>‚öôÔ∏è Advanced Filters</summary>
                <div class="filter-content">
                    <div class="filter-item">
                        <label>Category:</label>
                        <select @bind="categoryFilter" class="filter-select">
                            <option value="">All Categories</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Max Results:</label>
                        <input type="number" @bind="topK" min="5" max="50" class="filter-input" />
                    </div>
                    <div class="filter-item">
                        <label>Min Similarity:</label>
                        <input type="range" @bind="minSimilarity" min="0.5" max="1.0" step="0.05" class="filter-range" />
                        <span class="range-value">@minSimilarity.ToString("F2")</span>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- Search Results -->
    @if (hasSearched)
    {
        <div class="results-section">
            @if (isSearching)
            {
                <div class="loading-state">
                    <div class="spinner-large"></div>
                    <p>Searching...</p>
                </div>
            }
            else if (searchResults.Any())
            {
                <div class="results-header">
                    <h3>üìä Search Results</h3>
                    <div class="results-meta">
                        <span class="results-count">Found <strong>@searchResults.Count</strong> results</span>
                        <span class="results-time">in <strong>@queryTime.ToString("F0")</strong>ms</span>
                        <span class="results-type">using <strong>@searchType</strong> search</span>
                    </div>
                </div>

                <div class="results-list">
                    @foreach (var result in searchResults)
                    {
                        <div class="result-card" @onclick="() => ViewDocument(result)">
                            <div class="result-header">
                                <div class="result-icon">@GetFileIcon(result.Document.FileName)</div>
                                <div class="result-info">
                                    <h4 class="result-title">@result.Document.FileName</h4>
                                    <p class="result-category">
                                        <span class="icon">üìÇ</span>
                                        @(result.Document.ActualCategory ?? "Uncategorized")
                                    </p>
                                </div>
                                <div class="result-scores">
                                    @if (searchType == "hybrid")
                                    {
                                        <div class="score-item" title="Combined Score">
                                            <span class="score-label">Combined</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: @((result.CombinedScore * 100))%"></div>
                                            </div>
                                            <span class="score-value">@result.CombinedScore.ToString("F2")</span>
                                        </div>
                                    }
                                    else if (searchType == "vector")
                                    {
                                        <div class="score-item" title="Vector Similarity">
                                            <span class="score-label">Similarity</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: @((result.VectorScore * 100))%"></div>
                                            </div>
                                            <span class="score-value">@result.VectorScore.ToString("F2")</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="score-item" title="Text Match Score">
                                            <span class="score-label">Match</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: @((result.TextScore * 100))%"></div>
                                            </div>
                                            <span class="score-value">@result.TextScore.ToString("F2")</span>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="result-body">
                                <p class="result-excerpt">@GetExcerpt(result.Document.ExtractedText)</p>
                                <div class="result-meta">
                                    <span>üìä @FormatFileSize(result.Document.FileSize)</span>
                                    <span>üìÖ @result.Document.UploadedAt.ToString("MMM dd, yyyy")</span>
                                    <span>üëÅÔ∏è @result.Document.AccessCount views</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-results">
                    <div class="empty-icon">üîç</div>
                    <h3>No results found</h3>
                    <p>Try adjusting your search query or filters</p>
                </div>
            }
        </div>
    }
    else
    {
        <!-- Welcome State -->
        <div class="welcome-state">
            <div class="welcome-icon">üîç</div>
            <h2>Search Your Documents</h2>
            <p>Use our powerful search to find exactly what you need</p>
            
            <div class="search-methods">
                <div class="method-card">
                    <div class="method-icon">‚ö°</div>
                    <h4>Hybrid Search</h4>
                    <p>Combines vector similarity and keyword matching for best results</p>
                </div>
                <div class="method-card">
                    <div class="method-icon">üß†</div>
                    <h4>Vector Search</h4>
                    <p>Finds semantically similar documents using AI embeddings</p>
                </div>
                <div class="method-card">
                    <div class="method-icon">üìù</div>
                    <h4>Text Search</h4>
                    <p>Traditional keyword-based search through document content</p>
                </div>
            </div>

            <div class="example-queries">
                <h4>Try these example queries:</h4>
                <button class="example-btn" @onclick='() => SetQuery("contracts from last quarter")'>
                    "contracts from last quarter"
                </button>
                <button class="example-btn" @onclick='() => SetQuery("technical documentation")'>
                    "technical documentation"
                </button>
                <button class="example-btn" @onclick='() => SetQuery("financial reports 2024")'>
                    "financial reports 2024"
                </button>
            </div>
        </div>
    }
</div>

@code {
    private string searchQuery = string.Empty;
    private string searchType = "hybrid"; // hybrid, vector, text
    private string categoryFilter = string.Empty;
    private int topK = 10;
    private double minSimilarity = 0.7;
    private bool isSearching = false;
    private bool hasSearched = false;
    private double queryTime = 0;

    private List<SearchResult> searchResults = new();
    private List<string> categories = new();
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        
        // Load categories for filter (you might want to fetch from API)
        categories = new List<string> { "Documents", "Contracts", "Reports", "Technical", "Financial", "Notes" };
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return;

        isSearching = true;
        hasSearched = true;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("BackendAPI");
            
            var request = new
            {
                Query = searchQuery,
                TopK = topK,
                MinSimilarity = minSimilarity,
                CategoryFilter = string.IsNullOrEmpty(categoryFilter) ? null : categoryFilter,
                UserId = currentUserId
            };

            var response = await httpClient.PostAsJsonAsync($"api/search/{searchType}", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SearchResponse>();
                if (result != null)
                {
                    searchResults = result.Results;
                    queryTime = result.QueryTimeMs;
                }
            }
            else
            {
                searchResults = new List<SearchResult>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
            searchResults = new List<SearchResult>();
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }

    private void SetSearchType(string type)
    {
        searchType = type;
    }

    private void SetQuery(string query)
    {
        searchQuery = query;
    }

    private void ViewDocument(SearchResult result)
    {
        // TODO: Implement document viewer or navigate to document details
    }

    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "üìï",
            ".doc" or ".docx" => "üìò",
            ".xls" or ".xlsx" => "üìó",
            ".ppt" or ".pptx" => "üìô",
            ".txt" => "üìÑ",
            ".jpg" or ".jpeg" or ".png" => "üñºÔ∏è",
            _ => "üìÑ"
        };
    }

    private string GetExcerpt(string text, int maxLength = 200)
    {
        if (string.IsNullOrEmpty(text))
            return "No content preview available";
        
        if (text.Length <= maxLength)
            return text;
        
        return text.Substring(0, maxLength) + "...";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    // Models matching the API
    private class SearchResult
    {
        public Document Document { get; set; } = null!;
        public double VectorScore { get; set; }
        public double TextScore { get; set; }
        public double CombinedScore { get; set; }
    }

    private class SearchResponse
    {
        public string Query { get; set; } = string.Empty;
        public List<SearchResult> Results { get; set; } = new();
        public int TotalResults { get; set; }
        public double QueryTimeMs { get; set; }
        public string SearchType { get; set; } = string.Empty;
    }

    private class Document
    {
        public int Id { get; set; }
        public string FileName { get; set; } = string.Empty;
        public string ExtractedText { get; set; } = string.Empty;
        public string? ActualCategory { get; set; }
        public long FileSize { get; set; }
        public DateTime UploadedAt { get; set; }
        public int AccessCount { get; set; }
    }
}

<style>
    .search-page {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #666;
        font-size: 1.1rem;
    }

    .search-container {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .search-input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-input-large {
        flex: 1;
        padding: 1.2rem 1.5rem;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 1.1rem;
        transition: all 0.3s;
    }

    .search-input-large:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .btn-search {
        padding: 1.2rem 2.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-search:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-search:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .search-type-selector {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .type-btn {
        padding: 1rem;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .type-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .type-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    .type-btn small {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .advanced-filters {
        margin-top: 1rem;
    }

    .advanced-filters details {
        cursor: pointer;
    }

    .advanced-filters summary {
        padding: 0.8rem;
        background: #f8f9fa;
        border-radius: 8px;
        font-weight: 600;
        list-style: none;
    }

    .filter-content {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }

    .filter-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-item label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #555;
    }

    .filter-select, .filter-input {
        padding: 0.6rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
    }

    .filter-range {
        width: 100%;
    }

    .range-value {
        text-align: center;
        font-weight: 600;
        color: #667eea;
    }

    .results-section {
        animation: fadeIn 0.3s;
    }

    .results-header {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 15px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .results-header h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }

    .results-meta {
        display: flex;
        gap: 1.5rem;
        color: #666;
        font-size: 0.95rem;
    }

    .results-meta strong {
        color: #667eea;
        font-weight: 700;
    }

    .results-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .result-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.3s;
    }

    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .result-header {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .result-icon {
        font-size: 2.5rem;
    }

    .result-info {
        flex: 1;
    }

    .result-title {
        margin: 0 0 0.3rem 0;
        font-size: 1.2rem;
        color: #333;
    }

    .result-category {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .result-scores {
        min-width: 200px;
    }

    .score-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .score-label {
        font-weight: 600;
        min-width: 70px;
        color: #555;
    }

    .score-bar {
        flex: 1;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }

    .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s;
    }

    .score-value {
        font-weight: 700;
        color: #667eea;
    }

    .result-body {
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
    }

    .result-excerpt {
        color: #555;
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .result-meta {
        display: flex;
        gap: 1.5rem;
        color: #888;
        font-size: 0.85rem;
    }

    .welcome-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .welcome-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }

    .welcome-state h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .welcome-state p {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    .search-methods {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
        margin: 3rem 0;
    }

    .method-card {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }

    .method-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }

    .method-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .method-card h4 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .method-card p {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
    }

    .example-queries {
        margin-top: 2rem;
    }

    .example-queries h4 {
        margin-bottom: 1rem;
        color: #555;
    }

    .example-btn {
        margin: 0.5rem;
        padding: 0.8rem 1.5rem;
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .example-btn:hover {
        background: #667eea;
        color: white;
    }

    .empty-results {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }

    .empty-results h3 {
        margin-bottom: 0.5rem;
        color: #333;
    }

    .empty-results p {
        color: #666;
    }

    .loading-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .spinner-large {
        width: 60px;
        height: 60px;
        border: 5px solid #f0f0f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .spinner-small {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .icon {
        margin-right: 0.3rem;
    }
</style>
