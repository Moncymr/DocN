@page "/documents"
@page "/documents/{Page:int}"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using DocN.Data.Constants
@using Microsoft.Extensions.DependencyInjection
@inject IDocumentService DocumentService
@inject IDocumentStatisticsService StatisticsService
@inject IFileProcessingService FileProcessingService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IServiceScopeFactory ScopeFactory
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Documents - DocN</PageTitle>

<div class="documents-page">
    <!-- Header con ricerca e controlli -->
    <div class="page-header">
        <div class="header-left">
            <h1>üìö I Miei Documenti</h1>
            <p class="subtitle">@totalDocuments documenti nella tua libreria</p>
        </div>
        
        <div class="header-right">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" 
                       placeholder="Cerca documenti..." 
                       @bind="searchQuery" 
                       @bind:event="oninput"
                       @onkeyup="HandleSearch" 
                       class="search-input" />
            </div>
            
            <div class="view-toggle">
                <button class="toggle-btn @(viewMode == "list" ? "active" : "")" 
                        @onclick='() => SetViewMode("list")'
                        title="Vista Lista">
                    ‚ò∞
                </button>
                <button class="toggle-btn @(viewMode == "grid" ? "active" : "")" 
                        @onclick='() => SetViewMode("grid")'
                        title="Vista Griglia">
                    ‚äû
                </button>
            </div>
            
            <button class="btn-upload" @onclick="GoToUpload">
                <span>‚ûï Carica</span>
            </button>
        </div>
    </div>

    <!-- Filtri -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Categoria:</label>
            <select @bind="selectedCategory" @bind:after="ApplyFilters" class="filter-select">
                <option value="">Tutte le Categorie</option>
                @foreach (var category in categories)
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
        
        <div class="filter-group">
            <label>Ordina per:</label>
            <select @bind="sortBy" @bind:after="ApplyFilters" class="filter-select">
                <option value="date-desc">Pi√π Recenti</option>
                <option value="date-asc">Pi√π Vecchi</option>
                <option value="name-asc">Nome (A-Z)</option>
                <option value="name-desc">Nome (Z-A)</option>
                <option value="size-desc">Pi√π Grandi</option>
                <option value="access-desc">Pi√π Consultati</option>
            </select>
        </div>
        
        @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(selectedCategory))
        {
            <button class="btn-clear-filters" @onclick="ClearFilters">
                ‚úï Cancella Filtri
            </button>
        }
    </div>

    @* Loading State *@
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-large"></div>
            <p>Caricamento documenti in corso...</p>
        </div>
    }
    @* Empty State *@
    else if (!filteredDocuments.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <h3>Nessun documento trovato</h3>
            @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(selectedCategory))
            {
                <p>Prova ad aggiustare i filtri o i termini di ricerca</p>
                <button class="btn-secondary" @onclick="ClearFilters">Cancella Filtri</button>
            }
            else
            {
                <p>Carica il tuo primo documento per iniziare!</p>
                <button class="btn-primary" @onclick="GoToUpload">
                    ‚ûï Carica Documento
                </button>
            }
        </div>
    }
    @* Document Display *@
    else
    {
        @if (viewMode == "list")
        {
            <!-- LIST VIEW -->
            <div class="documents-list">
                @foreach (var doc in filteredDocuments)
                {
                    <div class="doc-list-item @(selectedDocument?.Id == doc.Id ? "selected" : "")"
                         @onclick="() => SelectDocument(doc)">
                        <div class="doc-icon">@GetFileIcon(doc.FileName)</div>
                        
                        <div class="doc-info">
                            <h4 class="doc-title">@doc.FileName</h4>
                            <div class="doc-meta">
                                <span class="meta-item">
                                    <span class="meta-icon">üìÇ</span>
                                    @(doc.ActualCategory ?? "Senza Categoria")
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üìä</span>
                                    @FormatFileSize(doc.FileSize)
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üìÖ</span>
                                    @doc.UploadedAt.ToString("dd MMM yyyy")
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üëÅÔ∏è</span>
                                    @doc.AccessCount visualizzazioni
                                </span>
                                @if (!string.IsNullOrEmpty(doc.AITagsJson))
                                {
                                    var tags = ParseAITags(doc.AITagsJson);
                                    if (tags != null && tags.Any())
                                    {
                                        <span class="meta-item">
                                            <span class="meta-icon">üè∑Ô∏è</span>
                                            @tags.Count tag AI
                                        </span>
                                    }
                                }
                            </div>
                        </div>
                        
                        <div class="doc-badges">
                            <span class="badge badge-@doc.Visibility.ToString().ToLower()">
                                @GetVisibilityIcon(doc.Visibility) @GetVisibilityLabel(doc.Visibility)
                            </span>
                            
                            @* Chunk Embedding Status Badge *@
                            @if (!string.IsNullOrEmpty(doc.ChunkEmbeddingStatus))
                            {
                                @if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Pending)
                                {
                                    <span class="badge badge-warning" title="Gli embeddings dei chunks stanno per essere generati">
                                        ‚è≥ Embeddings in coda
                                    </span>
                                }
                                else if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Processing)
                                {
                                    <span class="badge badge-info" title="Generazione embeddings in corso...">
                                        ‚öôÔ∏è Elaborazione...
                                    </span>
                                }
                                else if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Completed)
                                {
                                    <span class="badge badge-success" title="Documento pronto per ricerca semantica">
                                        ‚úì Pronto
                                    </span>
                                }
                            }
                        </div>
                        
                        <div class="doc-actions">
                            <button class="action-btn" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => DownloadDocument(doc)" 
                                    title="Scarica">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 12l-4-4h2.5V4h3v4H12l-4 4zm6-1v3H2v-3H0v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2z"/></svg>
                            </button>
                            <button class="action-btn" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ShareDocument(doc)" 
                                    title="Condividi">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13 7c-1.1 0-2.1.6-2.6 1.5L6.9 6.8c.1-.3.1-.5.1-.8s0-.5-.1-.8l3.5-1.7C10.9 4.4 11.9 5 13 5c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .3 0 .5.1.8L6.6 4.5C6.1 3.6 5.1 3 4 3 2.3 3 1 4.3 1 6s1.3 3 3 3c1.1 0 2.1-.6 2.6-1.5l3.5 1.7c-.1.3-.1.5-.1.8 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3z"/></svg>
                            </button>
                            <button class="action-btn action-primary" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewDocumentDetails(doc)" 
                                    title="Vedi Dettagli">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3C4.5 3 1.5 5.3 0 8.5c1.5 3.2 4.5 5.5 8 5.5s6.5-2.3 8-5.5C14.5 5.3 11.5 3 8 3zm0 9c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm0-6.5c-1.4 0-2.5 1.1-2.5 2.5s1.1 2.5 2.5 2.5 2.5-1.1 2.5-2.5-1.1-2.5-2.5-2.5z"/></svg>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- GRID VIEW -->
            <div class="documents-grid">
                @foreach (var doc in filteredDocuments)
                {
                    <div class="doc-grid-card" @onclick="() => SelectDocument(doc)">
                        <div class="card-header">
                            <div class="doc-icon-large">@GetFileIcon(doc.FileName)</div>
                            <div class="header-badges">
                                <span class="badge badge-@doc.Visibility.ToString().ToLower()">
                                    @GetVisibilityIcon(doc.Visibility)
                                </span>
                                
                                @* Chunk Embedding Status Badge *@
                                @if (!string.IsNullOrEmpty(doc.ChunkEmbeddingStatus))
                                {
                                    @if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Pending)
                                    {
                                        <span class="badge badge-warning" title="Gli embeddings dei chunks stanno per essere generati">
                                            ‚è≥
                                        </span>
                                    }
                                    else if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Processing)
                                    {
                                        <span class="badge badge-info" title="Generazione embeddings in corso...">
                                            ‚öôÔ∏è
                                        </span>
                                    }
                                    else if (doc.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Completed)
                                    {
                                        <span class="badge badge-success" title="Documento pronto per ricerca semantica">
                                            ‚úì
                                        </span>
                                    }
                                }
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <h4 class="doc-title" title="@doc.FileName">@TruncateText(doc.FileName, 30)</h4>
                            <p class="doc-category">
                                <span class="category-icon">üìÇ</span>
                                @(doc.ActualCategory ?? "Senza Categoria")
                            </p>
                            <div class="doc-stats">
                                <span title="Dimensione File">üìä @FormatFileSize(doc.FileSize)</span>
                                <span title="Visualizzazioni">üëÅÔ∏è @doc.AccessCount</span>
                            </div>
                            <p class="doc-date">@doc.UploadedAt.ToString("dd MMM yyyy")</p>
                        </div>
                        
                        <div class="card-actions">
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => DownloadDocument(doc)" 
                                    title="Scarica">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 12l-4-4h2.5V4h3v4H12l-4 4zm6-1v3H2v-3H0v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2z"/></svg>
                            </button>
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ShareDocument(doc)" 
                                    title="Condividi">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13 7c-1.1 0-2.1.6-2.6 1.5L6.9 6.8c.1-.3.1-.5.1-.8s0-.5-.1-.8l3.5-1.7C10.9 4.4 11.9 5 13 5c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .3 0 .5.1.8L6.6 4.5C6.1 3.6 5.1 3 4 3 2.3 3 1 4.3 1 6s1.3 3 3 3c1.1 0 2.1-.6 2.6-1.5l3.5 1.7c-.1.3-.1.5-.1.8 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3z"/></svg>
                            </button>
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewDocumentDetails(doc)" 
                                    title="Dettagli">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm1 13H7V7h2v6zm0-8H7V3h2v2z"/></svg>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="page-btn" 
                        disabled="@(currentPage == 1)" 
                        @onclick="PreviousPage">
                    ‚Üê Precedente
                </button>
                
                <div class="page-numbers">
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <button class="page-number @(currentPage == pageNum ? "active" : "")"
                                @onclick="() => GoToPage(pageNum)">
                            @pageNum
                        </button>
                    }
                </div>
                
                <button class="page-btn" 
                        disabled="@(currentPage == totalPages)" 
                        @onclick="NextPage">
                    Successivo ‚Üí
                </button>
            </div>
        }
    }

    <!-- Document Details Panel (Slide-in) -->
    @if (showDetailsPanel && selectedDocument != null)
    {
        <div class="details-overlay" @onclick="CloseDetailsPanel"></div>
        <div class="details-panel @(showDetailsPanel ? "open" : "")">
            <div class="panel-header">
                <h3>üìÑ Dettagli Documento</h3>
                <button class="btn-close" @onclick="CloseDetailsPanel">‚úï</button>
            </div>
            
            <div class="panel-body">
                <div class="detail-section">
                    <div class="doc-icon-xl">@GetFileIcon(selectedDocument.FileName)</div>
                    <h4 class="detail-title">@selectedDocument.FileName</h4>
                </div>
                
                <div class="detail-section">
                    <h5>üìã Informazioni</h5>
                    <dl class="detail-list">
                        <dt>Categoria:</dt>
                        <dd>@(selectedDocument.ActualCategory ?? "Senza Categoria")</dd>
                        
                        <dt>Dimensione:</dt>
                        <dd>@FormatFileSize(selectedDocument.FileSize)</dd>
                        
                        <dt>Tipo:</dt>
                        <dd>@selectedDocument.ContentType</dd>
                        
                        <dt>Caricato il:</dt>
                        <dd>@selectedDocument.UploadedAt.ToString("dd MMMM yyyy 'alle' HH:mm")</dd>
                        
                        <dt>Visualizzazioni:</dt>
                        <dd>@selectedDocument.AccessCount volte</dd>
                        
                        @if (selectedDocument.LastAccessedAt.HasValue)
                        {
                            <dt>Ultimo Accesso:</dt>
                            <dd>@selectedDocument.LastAccessedAt.Value.ToString("dd MMMM yyyy")</dd>
                        }
                        
                        <dt>Visibilit√†:</dt>
                        <dd>
                            <span class="badge badge-@selectedDocument.Visibility.ToString().ToLower()">
                                @GetVisibilityIcon(selectedDocument.Visibility) @GetVisibilityLabel(selectedDocument.Visibility)
                            </span>
                        </dd>
                    </dl>
                </div>
                
                @if (!string.IsNullOrEmpty(selectedDocument.CategoryReasoning))
                {
                    <div class="detail-section">
                        <h5>üí° Motivazione Classificazione AI</h5>
                        <p class="reasoning-text">@selectedDocument.CategoryReasoning</p>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(selectedDocument.AITagsJson))
                {
                    <div class="detail-section">
                        <h5>üè∑Ô∏è Analisi Tag AI</h5>
                        <div class="ai-tags-container">
                            @{
                                var tags = ParseAITags(selectedDocument.AITagsJson);
                                if (tags != null && tags.Any())
                                {
                                    foreach (var tag in tags)
                                    {
                                        <span class="ai-tag" style="opacity: @(0.5 + tag.Confidence * 0.5)" title="Confidenza: @((tag.Confidence * 100).ToString("F0"))%">
                                            @tag.Name
                                            <span class="tag-confidence">@((tag.Confidence * 100).ToString("F0"))%</span>
                                        </span>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">Nessun tag AI disponibile</p>
                                }
                            }
                        </div>
                        @if (selectedDocument.AIAnalysisDate.HasValue)
                        {
                            <p class="analysis-date">
                                <small>Analisi eseguita: @selectedDocument.AIAnalysisDate.Value.ToString("dd MMM yyyy")</small>
                            </p>
                        }
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(selectedDocument.ExtractedText))
                {
                    <div class="detail-section">
                        <h5>üìù Anteprima Contenuto</h5>
                        <div class="content-preview">
                            @TruncateText(selectedDocument.ExtractedText, 500)
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(selectedDocument.ExtractedMetadataJson))
                {
                    <div class="detail-section">
                        <h5>üìä Metadati Estratti</h5>
                        @{
                            var metadata = ParseMetadata(selectedDocument.ExtractedMetadataJson);
                            if (metadata != null && metadata.Any())
                            {
                                <div class="metadata-grid">
                                    @foreach (var (key, value) in metadata)
                                    {
                                        <div class="metadata-item">
                                            <span class="metadata-key">@FormatMetadataKey(key)</span>
                                            <span class="metadata-value">@value</span>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">Formato metadati non valido</p>
                            }
                        }
                    </div>
                }
                
                <div class="detail-actions">
                    <button class="btn-action btn-download" @onclick="() => DownloadDocument(selectedDocument)">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;"><path d="M8 12l-4-4h2.5V4h3v4H12l-4 4zm6-1v3H2v-3H0v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2z"/></svg>
                        Scarica
                    </button>
                    <button class="btn-action btn-share" @onclick="() => ShareDocument(selectedDocument)">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;"><path d="M13 7c-1.1 0-2.1.6-2.6 1.5L6.9 6.8c.1-.3.1-.5.1-.8s0-.5-.1-.8l3.5-1.7C10.9 4.4 11.9 5 13 5c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .3 0 .5.1.8L6.6 4.5C6.1 3.6 5.1 3 4 3 2.3 3 1 4.3 1 6s1.3 3 3 3c1.1 0 2.1-.6 2.6-1.5l3.5 1.7c-.1.3-.1.5-.1.8 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3z"/></svg>
                        Condividi
                    </button>
                    <button class="btn-action btn-delete" @onclick="() => DeleteDocument(selectedDocument)">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 0.5rem;"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        Elimina
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    * {
        box-sizing: border-box;
    }

    .documents-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 2rem;
    }

    /* HEADER */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header-left h1 {
        margin: 0;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        margin: 0.5rem 0 0 0;
        color: #666;
        font-size: 1rem;
    }

    .header-right {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    /* SEARCH BOX */
    .search-box {
        position: relative;
        width: 300px;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    /* VIEW TOGGLE */
    .view-toggle {
        display: flex;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 0.3rem;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        border: 1px solid #dee2e6;
    }

    .toggle-btn {
        background: transparent;
        border: none;
        padding: 0.55rem 1.1rem;
        font-size: 1.2rem;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #6c757d;
    }

    .toggle-btn:hover {
        background: rgba(255, 255, 255, 0.5);
        color: #495057;
    }

    .toggle-btn.active {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        color: #FF6B35;
        font-weight: 600;
    }

    /* UPLOAD BUTTON */
    .btn-upload {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }

    /* FILTERS BAR */
    .filters-bar {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #555;
    }

    .filter-select {
        padding: 0.6rem 1.2rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        font-weight: 500;
    }

    .filter-select:hover {
        border-color: #cbd5e0;
        background: white;
    }

    .filter-select:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        background: white;
    }

    .btn-clear-filters {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        margin-left: auto;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.25);
    }

    .btn-clear-filters:hover {
        background: linear-gradient(135deg, #ee5a52 0%, #dc3545 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    /* LOADING STATE */
    .loading-state {
        text-align: center;
        padding: 5rem 2rem;
    }

    .spinner-large {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #FF6B35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 2rem;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #333;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 2rem;
    }

    /* LIST VIEW */
    .documents-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .doc-list-item {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .doc-list-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-color: rgba(255, 107, 53, 0.2);
    }

    .doc-list-item.selected {
        border: 2px solid #FF6B35;
        box-shadow: 0 6px 20px rgba(255, 107, 53, 0.25);
        background: linear-gradient(135deg, #fff7f4 0%, #fffaf8 100%);
    }

    .doc-icon {
        font-size: 3rem;
        flex-shrink: 0;
    }

    .doc-info {
        flex: 1;
        min-width: 0;
    }

    .doc-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.2rem;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .doc-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        color: #666;
        font-size: 0.9rem;
    }

    .meta-icon {
        font-size: 1rem;
    }

    .doc-badges {
        display: flex;
        gap: 0.5rem;
    }

    .badge {
        padding: 0.45rem 0.9rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }

    .badge-private {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .badge-shared {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border: 1px solid #b8daff;
    }

    .badge-organization {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .badge-public {
        background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border: 1px solid #ffeaa7;
        animation: pulse 2s ease-in-out infinite;
        will-change: opacity;
    }
    
    .badge-info {
        background: linear-gradient(135deg, #cfe2ff 0%, #b6d4fe 100%);
        color: #084298;
        border: 1px solid #b6d4fe;
        animation: pulse 2s ease-in-out infinite;
        will-change: opacity;
    }
    
    .badge-success {
        background: linear-gradient(135deg, #d1e7dd 0%, #badbcc 100%);
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    
    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .doc-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .header-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .doc-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .action-btn {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        color: #495057;
    }

    .action-btn svg {
        width: 16px;
        height: 16px;
    }

    .action-btn:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #adb5bd;
    }

    .action-primary {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
        color: white;
    }

    .action-primary:hover {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
    }

    /* GRID VIEW */
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .doc-grid-card {
        background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .doc-grid-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 28px rgba(0,0,0,0.15);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-color: rgba(255, 107, 53, 0.2);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .doc-icon-large {
        font-size: 4rem;
    }

    .card-body {
        flex: 1;
    }

    .doc-category {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
        font-size: 0.9rem;
        margin: 0.5rem 0;
    }

    .doc-stats {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
        font-size: 0.85rem;
        color: #888;
    }

    .doc-date {
        color: #999;
        font-size: 0.85rem;
        margin: 0.5rem 0 0 0;
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
        margin-top: 1rem;
    }

    .action-btn-small {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        padding: 0.6rem 0.9rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        color: #495057;
    }

    .action-btn-small svg {
        width: 16px;
        height: 16px;
    }

    .action-btn-small:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #adb5bd;
    }

    /* PAGINATION */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .page-btn {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .page-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-color: #FF6B35;
        color: #FF6B35;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 107, 53, 0.15);
    }

    .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        box-shadow: none;
    }

    .page-numbers {
        display: flex;
        gap: 0.5rem;
    }

    .page-number {
        padding: 0.6rem 1rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .page-number:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-color: #FF6B35;
        color: #FF6B35;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 107, 53, 0.15);
    }

    .page-number.active {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        transform: translateY(-1px);
    }

    .page-number.active:hover {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
    }

    /* DETAILS PANEL */
    .details-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        animation: fadeIn 0.3s;
    }

    .details-panel {
        position: fixed;
        right: -500px;
        top: 0;
        bottom: 0;
        width: 500px;
        background: white;
        box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .details-panel.open {
        right: 0;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem;
        border-bottom: 1px solid #e0e0e0;
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .btn-close {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
    }

    .detail-section {
        margin-bottom: 2rem;
    }

    .doc-icon-xl {
        font-size: 5rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .detail-title {
        text-align: center;
        margin: 0 0 1rem 0;
        font-size: 1.3rem;
        word-break: break-word;
    }

    .detail-section h5 {
        margin: 0 0 1rem 0;
        color: #FF6B35;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-list {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.8rem;
        font-size: 0.95rem;
    }

    .detail-list dt {
        font-weight: 600;
        color: #555;
    }

    .detail-list dd {
        margin: 0;
        color: #333;
    }

    .reasoning-text {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        line-height: 1.6;
        color: #555;
        border-left: 4px solid #FF6B35;
    }

    .content-preview {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        line-height: 1.6;
        color: #555;
        font-family: monospace;
        font-size: 0.9rem;
    }

    .ai-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .ai-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .ai-tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
    }

    .tag-confidence {
        font-size: 0.75rem;
        opacity: 0.9;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
    }

    .analysis-date {
        margin-top: 0.8rem;
        color: #888;
        font-size: 0.85rem;
    }

    .text-muted {
        color: #999;
        font-style: italic;
    }

    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.8rem;
        margin-top: 0.5rem;
    }

    .metadata-item {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 0.8rem;
        border-radius: 8px;
        border-left: 3px solid #48bb78;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }

    .metadata-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .metadata-key {
        display: block;
        font-size: 0.75rem;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
    }

    .metadata-value {
        display: block;
        font-size: 0.95rem;
        color: #333;
        font-weight: 500;
        word-break: break-word;
    }

    .detail-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-action {
        padding: 1rem;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-action svg {
        flex-shrink: 0;
    }

    .btn-download {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
    }

    .btn-download:hover {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .btn-share {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }

    .btn-share:hover {
        background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-delete:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* BUTTONS */
    .btn-primary {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        color: white;
        border: none;
        padding: 0.85rem 1.75rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #F7931E 0%, #E67E22 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        border: none;
        padding: 0.85rem 1.75rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #5a6268 0%, #545b62 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
    }

    /* ANIMATIONS */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* RESPONSIVE */
    @@media (max-width: 1024px) {
        .page-header {
            flex-direction: column;
            gap: 1.5rem;
        }

        .header-right {
            width: 100%;
            flex-wrap: wrap;
        }

        .search-box {
            width: 100%;
        }

        .documents-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        .details-panel {
            width: 100%;
            right: -100%;
        }
    }

    @@media (max-width: 768px) {
        .documents-page {
            padding: 1rem;
        }

        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            flex-direction: column;
            align-items: stretch;
        }

        .documents-grid {
            grid-template-columns: 1fr;
        }

        .doc-list-item {
            flex-direction: column;
            align-items: start;
        }

        .doc-actions {
            width: 100%;
            justify-content: space-around;
        }
    }
</style>

@code {
    [Parameter]
    public int Page { get; set; } = 1;

    private List<Document>? documents;
    private List<Document> filteredDocuments = new();
    private List<string> categories = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private int totalPages = 1;
    private int totalDocuments = 0;
    private int pageSize = 20;
    private string currentUserId = string.Empty;
    
    // Filters and search
    private string searchQuery = string.Empty;
    private string selectedCategory = string.Empty;
    private string sortBy = "date-desc";
    
    // View mode
    private string viewMode = "list"; // "list" or "grid"
    
    // Details panel
    private bool showDetailsPanel = false;
    private Document? selectedDocument = null;
    
    // Auto-refresh for processing documents
    private System.Threading.Timer? refreshTimer;
    private bool hasProcessingDocuments = false;
    private readonly SemaphoreSlim _refreshSemaphore = new SemaphoreSlim(1, 1);
    private bool _isRefreshing = false;

    private bool _firstRender = true;
    
    protected override async Task OnInitializedAsync()
    {
        // Get user ID synchronously from auth state
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        
        currentPage = Page > 0 ? Page : 1;
        
        // Don't load data here - let OnAfterRenderAsync handle it for faster initial render
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _firstRender)
        {
            _firstRender = false;
            try
            {
                // Load documents after first render for faster page display
                await LoadDocuments();
                
                // Setup auto-refresh timer if there are processing documents
                SetupAutoRefresh();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading documents: {ex.Message}");
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadDocuments()
    {
        try
        {
            isLoading = true;
            // StateHasChanged() only if not first render - first render already shows loading state
            if (!_firstRender)
            {
                StateHasChanged(); // Force UI update to show loading state
            }
            
            // Use proper pagination - only load documents for current page
            // This respects the pageSize setting (default 20)
            documents = await DocumentService.GetUserDocumentsAsync(currentUserId, currentPage, pageSize);
            totalDocuments = await DocumentService.GetTotalDocumentCountAsync(currentUserId);
            
            // Calculate total pages for pagination
            totalPages = (int)Math.Ceiling((double)totalDocuments / pageSize);
            
            // Extract unique categories from loaded documents
            if (documents != null)
            {
                categories = documents
                    .Where(d => !string.IsNullOrEmpty(d.ActualCategory))
                    .Select(d => d.ActualCategory!)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList();
                
                // Check if any documents are still being processed
                hasProcessingDocuments = documents.Any(d => 
                    d.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Pending || 
                    d.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Processing);
            }
            
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading documents: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Force UI update to show documents
        }
    }
    
    private void SetupAutoRefresh()
    {
        // If there are documents being processed, setup auto-refresh every 10 seconds
        if (hasProcessingDocuments)
        {
            refreshTimer?.Dispose();
            refreshTimer = new System.Threading.Timer(async _ =>
            {
                // Prevent concurrent executions
                if (_isRefreshing || !await _refreshSemaphore.WaitAsync(0))
                    return;

                try
                {
                    _isRefreshing = true;
                    
                    await InvokeAsync(async () =>
                    {
                        try
                        {
                            // Create a new scope to get a fresh DbContext instance
                            using var scope = ScopeFactory.CreateScope();
                            var scopedDocumentService = scope.ServiceProvider.GetRequiredService<IDocumentService>();
                            
                            // Load documents using the scoped service with proper pagination
                            var docs = await scopedDocumentService.GetUserDocumentsAsync(currentUserId, currentPage, pageSize);
                            var total = await scopedDocumentService.GetTotalDocumentCountAsync(currentUserId);
                            
                            // Update component state
                            documents = docs;
                            totalDocuments = total;
                            totalPages = (int)Math.Ceiling((double)totalDocuments / pageSize);
                            
                            // Extract unique categories
                            if (documents != null)
                            {
                                categories = documents
                                    .Where(d => !string.IsNullOrEmpty(d.ActualCategory))
                                    .Select(d => d.ActualCategory!)
                                    .Distinct()
                                    .OrderBy(c => c)
                                    .ToList();
                                
                                // Check if any documents are still being processed
                                hasProcessingDocuments = documents.Any(d => 
                                    d.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Pending || 
                                    d.ChunkEmbeddingStatus == ChunkEmbeddingStatus.Processing);
                            }
                            
                            ApplyFilters();
                            StateHasChanged();
                            
                            // If no more processing documents, stop the timer
                            if (!hasProcessingDocuments)
                            {
                                refreshTimer?.Dispose();
                                refreshTimer = null;
                            }
                        }
                        catch (Exception ex)
                        {
                            // Log error but don't crash the component
                            Console.WriteLine($"Error refreshing documents: {ex.Message}");
                        }
                    });
                }
                finally
                {
                    _isRefreshing = false;
                    _refreshSemaphore.Release();
                }
            }, null, TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(10));
        }
    }
    
    public void Dispose()
    {
        refreshTimer?.Dispose();
        _refreshSemaphore?.Dispose();
    }

    private void ApplyFilters()
    {
        if (documents == null) 
        {
            filteredDocuments = new List<Document>();
            return;
        }

        var filtered = documents.AsEnumerable();

        // Search filter (client-side on current page)
        if (!string.IsNullOrEmpty(searchQuery))
        {
            filtered = filtered.Where(d => 
                d.FileName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                (d.ActualCategory?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (d.ExtractedText?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Category filter (client-side on current page)
        if (!string.IsNullOrEmpty(selectedCategory))
        {
            filtered = filtered.Where(d => d.ActualCategory == selectedCategory);
        }

        // Sort (client-side on current page)
        filtered = sortBy switch
        {
            "date-desc" => filtered.OrderByDescending(d => d.UploadedAt),
            "date-asc" => filtered.OrderBy(d => d.UploadedAt),
            "name-asc" => filtered.OrderBy(d => d.FileName),
            "name-desc" => filtered.OrderByDescending(d => d.FileName),
            "size-desc" => filtered.OrderByDescending(d => d.FileSize),
            "access-desc" => filtered.OrderByDescending(d => d.AccessCount),
            _ => filtered.OrderByDescending(d => d.UploadedAt)
        };

        // Since we're loading from server with pagination, just display what we loaded
        filteredDocuments = filtered.ToList();
    }

    private async Task HandleSearch()
    {
        // When searching, reload from server starting at page 1
        currentPage = 1;
        await LoadDocuments();
    }

    private async Task ClearFilters()
    {
        searchQuery = string.Empty;
        selectedCategory = string.Empty;
        currentPage = 1;
        await LoadDocuments();
    }

    private void SetViewMode(string mode)
    {
        viewMode = mode;
    }

    private void SelectDocument(Document doc)
    {
        selectedDocument = doc;
    }

    private void ViewDocumentDetails(Document doc)
    {
        selectedDocument = doc;
        showDetailsPanel = true;
    }

    private void CloseDetailsPanel()
    {
        showDetailsPanel = false;
    }

    private async Task DownloadDocument(Document doc)
    {
        try
        {
            var fileBytes = await DocumentService.DownloadDocumentAsync(doc.Id, currentUserId);
            if (fileBytes != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", doc.FileName, Convert.ToBase64String(fileBytes));
                await StatisticsService.UpdateDocumentAccessAsync(doc.Id);
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error downloading: {ex.Message}");
        }
    }

    private async Task ShareDocument(Document doc)
    {
        try
        {
            var shareUrl = $"{Navigation.BaseUri}documents?id={doc.Id}";
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", shareUrl);
            // Show a temporary success message
            await JSRuntime.InvokeVoidAsync("alert", $"Link copiato negli appunti!\n{shareUrl}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sharing: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Errore durante la copia del link di condivisione.");
        }
    }

    private async Task DeleteDocument(Document doc)
    {
        // Confirm deletion
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Sei sicuro di voler eliminare '{doc.FileName}'?");
        if (confirmed)
        {
            // TODO: Implement delete
            await LoadDocuments();
            CloseDetailsPanel();
        }
    }

    private void GoToUpload()
    {
        Navigation.NavigateTo("/upload");
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadDocuments();
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadDocuments();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadDocuments();
        }
    }

    private string GetFileIcon(string fileName)
    {
        return FileProcessingService.GetFileIcon(fileName);
    }

    private class AITag
    {
        public string Name { get; set; } = string.Empty;
        public double Confidence { get; set; }
    }

    private List<AITag>? ParseAITags(string? aiTagsJson)
    {
        if (string.IsNullOrEmpty(aiTagsJson))
            return null;

        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<List<AITag>>(aiTagsJson);
        }
        catch
        {
            return null;
        }
    }

    private string GetVisibilityIcon(DocumentVisibility visibility)
    {
        return visibility switch
        {
            DocumentVisibility.Private => "üîí",
            DocumentVisibility.Shared => "üë•",
            DocumentVisibility.Organization => "üè¢",
            DocumentVisibility.Public => "üåê",
            _ => "üìÑ"
        };
    }

    private string GetVisibilityLabel(DocumentVisibility visibility)
    {
        return visibility switch
        {
            DocumentVisibility.Private => "Privato",
            DocumentVisibility.Shared => "Condiviso",
            DocumentVisibility.Organization => "Organizzazione",
            DocumentVisibility.Public => "Pubblico",
            _ => "Sconosciuto"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text ?? string.Empty;
        return text.Substring(0, maxLength) + "...";
    }

    private Dictionary<string, string>? ParseMetadata(string? metadataJson)
    {
        if (string.IsNullOrEmpty(metadataJson))
            return null;

        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(metadataJson);
        }
        catch
        {
            return null;
        }
    }

    private string FormatMetadataKey(string key)
    {
        // Convert snake_case to space-separated words
        return string.Join(" ", key.Split('_'));
    }
}
