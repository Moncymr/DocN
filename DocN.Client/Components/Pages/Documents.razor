@page "/documents"
@page "/documents/{Page:int}"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject IDocumentService DocumentService
@inject IDocumentStatisticsService StatisticsService
@inject IFileProcessingService FileProcessingService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Documents - DocN</PageTitle>

<div class="documents-page">
    <!-- Header con ricerca e controlli -->
    <div class="page-header">
        <div class="header-left">
            <h1>üìö My Documents</h1>
            <p class="subtitle">@totalDocuments documents in your library</p>
        </div>
        
        <div class="header-right">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" 
                       placeholder="Search documents..." 
                       @bind="searchQuery" 
                       @bind:event="oninput"
                       @onkeyup="HandleSearch" 
                       class="search-input" />
            </div>
            
            <div class="view-toggle">
                <button class="toggle-btn @(viewMode == "list" ? "active" : "")" 
                        @onclick='() => SetViewMode("list")'
                        title="List View">
                    ‚ò∞
                </button>
                <button class="toggle-btn @(viewMode == "grid" ? "active" : "")" 
                        @onclick='() => SetViewMode("grid")'
                        title="Grid View">
                    ‚äû
                </button>
            </div>
            
            <button class="btn-upload" @onclick="GoToUpload">
                <span>‚ûï Upload</span>
            </button>
        </div>
    </div>

    <!-- Filtri -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Category:</label>
            <select @bind="selectedCategory" @bind:after="ApplyFilters" class="filter-select">
                <option value="">All Categories</option>
                @foreach (var category in categories)
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
        
        <div class="filter-group">
            <label>Sort by:</label>
            <select @bind="sortBy" @bind:after="ApplyFilters" class="filter-select">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="size-desc">Largest First</option>
                <option value="access-desc">Most Accessed</option>
            </select>
        </div>
        
        @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(selectedCategory))
        {
            <button class="btn-clear-filters" @onclick="ClearFilters">
                ‚úï Clear Filters
            </button>
        }
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-large"></div>
            <p>Loading your documents...</p>
        </div>
    }
    <!-- Empty State -->
    else if (!filteredDocuments.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <h3>No documents found</h3>
            @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(selectedCategory))
            {
                <p>Try adjusting your filters or search terms</p>
                <button class="btn-secondary" @onclick="ClearFilters">Clear Filters</button>
            }
            else
            {
                <p>Upload your first document to get started!</p>
                <button class="btn-primary" @onclick="GoToUpload">
                    ‚ûï Upload Document
                </button>
            }
        </div>
    }
    <!-- Document Display -->
    else
    {
        @if (viewMode == "list")
        {
            <!-- LIST VIEW -->
            <div class="documents-list">
                @foreach (var doc in filteredDocuments)
                {
                    <div class="doc-list-item @(selectedDocument?.Id == doc.Id ? "selected" : "")"
                         @onclick="() => SelectDocument(doc)">
                        <div class="doc-icon">@GetFileIcon(doc.FileName)</div>
                        
                        <div class="doc-info">
                            <h4 class="doc-title">@doc.FileName</h4>
                            <div class="doc-meta">
                                <span class="meta-item">
                                    <span class="meta-icon">üìÇ</span>
                                    @(doc.ActualCategory ?? "Uncategorized")
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üìä</span>
                                    @FormatFileSize(doc.FileSize)
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üìÖ</span>
                                    @doc.UploadedAt.ToString("MMM dd, yyyy")
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">üëÅÔ∏è</span>
                                    @doc.AccessCount views
                                </span>
                            </div>
                        </div>
                        
                        <div class="doc-badges">
                            <span class="badge badge-@doc.Visibility.ToString().ToLower()">
                                @GetVisibilityIcon(doc.Visibility) @doc.Visibility
                            </span>
                        </div>
                        
                        <div class="doc-actions">
                            <button class="action-btn" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => DownloadDocument(doc)" 
                                    title="Download">
                                ‚¨áÔ∏è
                            </button>
                            <button class="action-btn" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ShareDocument(doc)" 
                                    title="Share">
                                üîó
                            </button>
                            <button class="action-btn action-primary" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewDocumentDetails(doc)" 
                                    title="View Details">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- GRID VIEW -->
            <div class="documents-grid">
                @foreach (var doc in filteredDocuments)
                {
                    <div class="doc-grid-card" @onclick="() => SelectDocument(doc)">
                        <div class="card-header">
                            <div class="doc-icon-large">@GetFileIcon(doc.FileName)</div>
                            <span class="badge badge-@doc.Visibility.ToString().ToLower()">
                                @GetVisibilityIcon(doc.Visibility)
                            </span>
                        </div>
                        
                        <div class="card-body">
                            <h4 class="doc-title" title="@doc.FileName">@TruncateText(doc.FileName, 30)</h4>
                            <p class="doc-category">
                                <span class="category-icon">üìÇ</span>
                                @(doc.ActualCategory ?? "Uncategorized")
                            </p>
                            <div class="doc-stats">
                                <span title="File Size">üìä @FormatFileSize(doc.FileSize)</span>
                                <span title="Views">üëÅÔ∏è @doc.AccessCount</span>
                            </div>
                            <p class="doc-date">@doc.UploadedAt.ToString("MMM dd, yyyy")</p>
                        </div>
                        
                        <div class="card-actions">
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => DownloadDocument(doc)" 
                                    title="Download">
                                ‚¨áÔ∏è
                            </button>
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ShareDocument(doc)" 
                                    title="Share">
                                üîó
                            </button>
                            <button class="action-btn-small" 
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ViewDocumentDetails(doc)" 
                                    title="Details">
                                ‚ÑπÔ∏è
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="page-btn" 
                        disabled="@(currentPage == 1)" 
                        @onclick="PreviousPage">
                    ‚Üê Previous
                </button>
                
                <div class="page-numbers">
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <button class="page-number @(currentPage == pageNum ? "active" : "")"
                                @onclick="() => GoToPage(pageNum)">
                            @pageNum
                        </button>
                    }
                </div>
                
                <button class="page-btn" 
                        disabled="@(currentPage == totalPages)" 
                        @onclick="NextPage">
                    Next ‚Üí
                </button>
            </div>
        }
    }

    <!-- Document Details Panel (Slide-in) -->
    @if (showDetailsPanel && selectedDocument != null)
    {
        <div class="details-overlay" @onclick="CloseDetailsPanel"></div>
        <div class="details-panel @(showDetailsPanel ? "open" : "")">
            <div class="panel-header">
                <h3>üìÑ Document Details</h3>
                <button class="btn-close" @onclick="CloseDetailsPanel">‚úï</button>
            </div>
            
            <div class="panel-body">
                <div class="detail-section">
                    <div class="doc-icon-xl">@GetFileIcon(selectedDocument.FileName)</div>
                    <h4 class="detail-title">@selectedDocument.FileName</h4>
                </div>
                
                <div class="detail-section">
                    <h5>üìã Information</h5>
                    <dl class="detail-list">
                        <dt>Category:</dt>
                        <dd>@(selectedDocument.ActualCategory ?? "Uncategorized")</dd>
                        
                        <dt>File Size:</dt>
                        <dd>@FormatFileSize(selectedDocument.FileSize)</dd>
                        
                        <dt>Type:</dt>
                        <dd>@selectedDocument.ContentType</dd>
                        
                        <dt>Uploaded:</dt>
                        <dd>@selectedDocument.UploadedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</dd>
                        
                        <dt>Views:</dt>
                        <dd>@selectedDocument.AccessCount times</dd>
                        
                        @if (selectedDocument.LastAccessedAt.HasValue)
                        {
                            <dt>Last Accessed:</dt>
                            <dd>@selectedDocument.LastAccessedAt.Value.ToString("MMMM dd, yyyy")</dd>
                        }
                        
                        <dt>Visibility:</dt>
                        <dd>
                            <span class="badge badge-@selectedDocument.Visibility.ToString().ToLower()">
                                @GetVisibilityIcon(selectedDocument.Visibility) @selectedDocument.Visibility
                            </span>
                        </dd>
                    </dl>
                </div>
                
                @if (!string.IsNullOrEmpty(selectedDocument.CategoryReasoning))
                {
                    <div class="detail-section">
                        <h5>üí° AI Classification Reasoning</h5>
                        <p class="reasoning-text">@selectedDocument.CategoryReasoning</p>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(selectedDocument.ExtractedText))
                {
                    <div class="detail-section">
                        <h5>üìù Content Preview</h5>
                        <div class="content-preview">
                            @TruncateText(selectedDocument.ExtractedText, 500)
                        </div>
                    </div>
                }
                
                <div class="detail-actions">
                    <button class="btn-action btn-download" @onclick="() => DownloadDocument(selectedDocument)">
                        ‚¨áÔ∏è Download
                    </button>
                    <button class="btn-action btn-share" @onclick="() => ShareDocument(selectedDocument)">
                        üîó Share
                    </button>
                    <button class="btn-action btn-delete" @onclick="() => DeleteDocument(selectedDocument)">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    * {
        box-sizing: border-box;
    }

    .documents-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 2rem;
    }

    /* HEADER */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header-left h1 {
        margin: 0;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        margin: 0.5rem 0 0 0;
        color: #666;
        font-size: 1rem;
    }

    .header-right {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    /* SEARCH BOX */
    .search-box {
        position: relative;
        width: 300px;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 3rem;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* VIEW TOGGLE */
    .view-toggle {
        display: flex;
        background: #f0f0f0;
        border-radius: 8px;
        padding: 0.25rem;
    }

    .toggle-btn {
        background: transparent;
        border: none;
        padding: 0.5rem 1rem;
        font-size: 1.2rem;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s;
    }

    .toggle-btn:hover {
        background: #e0e0e0;
    }

    .toggle-btn.active {
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* UPLOAD BUTTON */
    .btn-upload {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    /* FILTERS BAR */
    .filters-bar {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #555;
    }

    .filter-select {
        padding: 0.5rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .filter-select:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn-clear-filters {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-left: auto;
    }

    /* LOADING STATE */
    .loading-state {
        text-align: center;
        padding: 5rem 2rem;
    }

    .spinner-large {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 2rem;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #333;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 2rem;
    }

    /* LIST VIEW */
    .documents-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .doc-list-item {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s;
        cursor: pointer;
    }

    .doc-list-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .doc-list-item.selected {
        border: 2px solid #667eea;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
    }

    .doc-icon {
        font-size: 3rem;
        flex-shrink: 0;
    }

    .doc-info {
        flex: 1;
        min-width: 0;
    }

    .doc-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.2rem;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .doc-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        color: #666;
        font-size: 0.9rem;
    }

    .meta-icon {
        font-size: 1rem;
    }

    .doc-badges {
        display: flex;
        gap: 0.5rem;
    }

    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-private {
        background: #fff3cd;
        color: #856404;
    }

    .badge-shared {
        background: #d1ecf1;
        color: #0c5460;
    }

    .badge-organization {
        background: #d4edda;
        color: #155724;
    }

    .badge-public {
        background: #d6d8db;
        color: #383d41;
    }

    .doc-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .action-btn {
        background: #f8f9fa;
        border: none;
        padding: 0.6rem;
        border-radius: 8px;
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .action-btn:hover {
        background: #e9ecef;
        transform: scale(1.1);
    }

    .action-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .action-primary:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* GRID VIEW */
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .doc-grid-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }

    .doc-grid-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .doc-icon-large {
        font-size: 4rem;
    }

    .card-body {
        flex: 1;
    }

    .doc-category {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
        font-size: 0.9rem;
        margin: 0.5rem 0;
    }

    .doc-stats {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
        font-size: 0.85rem;
        color: #888;
    }

    .doc-date {
        color: #999;
        font-size: 0.85rem;
        margin: 0.5rem 0 0 0;
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
        margin-top: 1rem;
    }

    .action-btn-small {
        background: #f8f9fa;
        border: none;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .action-btn-small:hover {
        background: #e9ecef;
        transform: scale(1.15);
    }

    /* PAGINATION */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .page-btn {
        padding: 0.75rem 1.5rem;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .page-btn:hover:not(:disabled) {
        border-color: #667eea;
        color: #667eea;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-numbers {
        display: flex;
        gap: 0.5rem;
    }

    .page-number {
        padding: 0.5rem 1rem;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .page-number:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .page-number.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    /* DETAILS PANEL */
    .details-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        animation: fadeIn 0.3s;
    }

    .details-panel {
        position: fixed;
        right: -500px;
        top: 0;
        bottom: 0;
        width: 500px;
        background: white;
        box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .details-panel.open {
        right: 0;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem;
        border-bottom: 1px solid #e0e0e0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .panel-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .btn-close {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
    }

    .detail-section {
        margin-bottom: 2rem;
    }

    .doc-icon-xl {
        font-size: 5rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .detail-title {
        text-align: center;
        margin: 0 0 1rem 0;
        font-size: 1.3rem;
        word-break: break-word;
    }

    .detail-section h5 {
        margin: 0 0 1rem 0;
        color: #667eea;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .detail-list {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 0.8rem;
        font-size: 0.95rem;
    }

    .detail-list dt {
        font-weight: 600;
        color: #555;
    }

    .detail-list dd {
        margin: 0;
        color: #333;
    }

    .reasoning-text {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        line-height: 1.6;
        color: #555;
        border-left: 4px solid #667eea;
    }

    .content-preview {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        line-height: 1.6;
        color: #555;
        font-family: monospace;
        font-size: 0.9rem;
    }

    .detail-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-action {
        padding: 1rem;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-download {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-share {
        background: #17a2b8;
        color: white;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* BUTTONS */
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    /* ANIMATIONS */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* RESPONSIVE */
    @@media (max-width: 1024px) {
        .page-header {
            flex-direction: column;
            gap: 1.5rem;
        }

        .header-right {
            width: 100%;
            flex-wrap: wrap;
        }

        .search-box {
            width: 100%;
        }

        .documents-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        .details-panel {
            width: 100%;
            right: -100%;
        }
    }

    @@media (max-width: 768px) {
        .documents-page {
            padding: 1rem;
        }

        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            flex-direction: column;
            align-items: stretch;
        }

        .documents-grid {
            grid-template-columns: 1fr;
        }

        .doc-list-item {
            flex-direction: column;
            align-items: start;
        }

        .doc-actions {
            width: 100%;
            justify-content: space-around;
        }
    }
</style>

@code {
    [Parameter]
    public int Page { get; set; } = 1;

    private List<Document>? documents;
    private List<Document> filteredDocuments = new();
    private List<string> categories = new();
    private bool isLoading = true;
    private int currentPage = 1;
    private int totalPages = 1;
    private int totalDocuments = 0;
    private int pageSize = 20;
    private string currentUserId = string.Empty;
    
    // Filters and search
    private string searchQuery = string.Empty;
    private string selectedCategory = string.Empty;
    private string sortBy = "date-desc";
    
    // View mode
    private string viewMode = "list"; // "list" or "grid"
    
    // Details panel
    private bool showDetailsPanel = false;
    private Document? selectedDocument = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        
        currentPage = Page > 0 ? Page : 1;
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        isLoading = true;
        
        documents = await DocumentService.GetUserDocumentsAsync(currentUserId, 1, 1000); // Load all for filtering
        totalDocuments = documents?.Count ?? 0;
        
        // Extract unique categories
        if (documents != null)
        {
            categories = documents
                .Where(d => !string.IsNullOrEmpty(d.ActualCategory))
                .Select(d => d.ActualCategory!)
                .Distinct()
                .OrderBy(c => c)
                .ToList();
        }
        
        ApplyFilters();
        isLoading = false;
    }

    private void ApplyFilters()
    {
        if (documents == null) return;

        var filtered = documents.AsEnumerable();

        // Search filter
        if (!string.IsNullOrEmpty(searchQuery))
        {
            filtered = filtered.Where(d => 
                d.FileName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                (d.ActualCategory?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (d.ExtractedText?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        // Category filter
        if (!string.IsNullOrEmpty(selectedCategory))
        {
            filtered = filtered.Where(d => d.ActualCategory == selectedCategory);
        }

        // Sort
        filtered = sortBy switch
        {
            "date-desc" => filtered.OrderByDescending(d => d.UploadedAt),
            "date-asc" => filtered.OrderBy(d => d.UploadedAt),
            "name-asc" => filtered.OrderBy(d => d.FileName),
            "name-desc" => filtered.OrderByDescending(d => d.FileName),
            "size-desc" => filtered.OrderByDescending(d => d.FileSize),
            "access-desc" => filtered.OrderByDescending(d => d.AccessCount),
            _ => filtered.OrderByDescending(d => d.UploadedAt)
        };

        // Pagination
        var allFiltered = filtered.ToList();
        totalPages = (int)Math.Ceiling((double)allFiltered.Count / pageSize);
        
        filteredDocuments = allFiltered
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task HandleSearch()
    {
        currentPage = 1;
        ApplyFilters();
        await Task.CompletedTask;
    }

    private void ClearFilters()
    {
        searchQuery = string.Empty;
        selectedCategory = string.Empty;
        currentPage = 1;
        ApplyFilters();
    }

    private void SetViewMode(string mode)
    {
        viewMode = mode;
    }

    private void SelectDocument(Document doc)
    {
        selectedDocument = doc;
    }

    private void ViewDocumentDetails(Document doc)
    {
        selectedDocument = doc;
        showDetailsPanel = true;
    }

    private void CloseDetailsPanel()
    {
        showDetailsPanel = false;
    }

    private async Task DownloadDocument(Document doc)
    {
        try
        {
            var fileBytes = await DocumentService.DownloadDocumentAsync(doc.Id, currentUserId);
            if (fileBytes != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", doc.FileName, Convert.ToBase64String(fileBytes));
                await StatisticsService.UpdateDocumentAccessAsync(doc.Id);
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error downloading: {ex.Message}");
        }
    }

    private void ShareDocument(Document doc)
    {
        Navigation.NavigateTo($"/share/{doc.Id}");
    }

    private async Task DeleteDocument(Document doc)
    {
        // Confirm deletion
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{doc.FileName}'?");
        if (confirmed)
        {
            // TODO: Implement delete
            await LoadDocuments();
            CloseDetailsPanel();
        }
    }

    private void GoToUpload()
    {
        Navigation.NavigateTo("/upload");
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        ApplyFilters();
        await Task.CompletedTask;
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            ApplyFilters();
        }
        await Task.CompletedTask;
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            ApplyFilters();
        }
        await Task.CompletedTask;
    }

    private string GetFileIcon(string fileName)
    {
        return FileProcessingService.GetFileIcon(fileName);
    }

    private string GetVisibilityIcon(DocumentVisibility visibility)
    {
        return visibility switch
        {
            DocumentVisibility.Private => "üîí",
            DocumentVisibility.Shared => "üë•",
            DocumentVisibility.Organization => "üè¢",
            DocumentVisibility.Public => "üåê",
            _ => "üìÑ"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text ?? string.Empty;
        return text.Substring(0, maxLength) + "...";
    }
}
