# Flexible Vector Dimensions Support

## üéØ Overview / Panoramica

**English:**
The system now supports flexible vector dimensions, allowing vectors generated by different AI providers with different dimensions to coexist in the same database.

**Italiano:**
Il sistema ora supporta dimensioni vettoriali flessibili, consentendo ai vettori generati da diversi provider AI con dimensioni diverse di coesistere nello stesso database.

## üîß What Changed / Cosa √® Cambiato

### Database Schema / Schema Database

**English:**
- Added `EmbeddingDimension` column to `Documents` table
- Added `EmbeddingDimension` column to `DocumentChunks` table
- These columns store the actual dimension of each embedding vector

**Italiano:**
- Aggiunta colonna `EmbeddingDimension` alla tabella `Documents`
- Aggiunta colonna `EmbeddingDimension` alla tabella `DocumentChunks`
- Queste colonne memorizzano la dimensione effettiva di ciascun vettore di embedding

### Code Changes / Modifiche al Codice

**English:**
1. **Models Updated:**
   - `Document.cs`: Added `EmbeddingDimension` property
   - `DocumentChunk.cs`: Added `EmbeddingDimension` property

2. **Validation Updated:**
   - `EmbeddingValidationHelper.cs`: Now accepts any dimension between 256 and 4096
   - Removed hardcoded checks for only 768 and 1536 dimensions

3. **Services Updated:**
   - `DocumentService.cs`: Automatically sets `EmbeddingDimension` when saving
   - `BatchEmbeddingProcessor.cs`: Sets dimension for all embeddings
   - `DocumentsController.cs`: Sets dimension when updating embeddings

**Italiano:**
1. **Modelli Aggiornati:**
   - `Document.cs`: Aggiunta propriet√† `EmbeddingDimension`
   - `DocumentChunk.cs`: Aggiunta propriet√† `EmbeddingDimension`

2. **Validazione Aggiornata:**
   - `EmbeddingValidationHelper.cs`: Ora accetta qualsiasi dimensione tra 256 e 4096
   - Rimossi controlli hardcoded solo per 768 e 1536 dimensioni

3. **Servizi Aggiornati:**
   - `DocumentService.cs`: Imposta automaticamente `EmbeddingDimension` durante il salvataggio
   - `BatchEmbeddingProcessor.cs`: Imposta la dimensione per tutti gli embedding
   - `DocumentsController.cs`: Imposta la dimensione durante l'aggiornamento degli embedding

## ‚úÖ Supported Dimensions / Dimensioni Supportate

### Common Configurations / Configurazioni Comuni

| Provider | Model | Default Dimension | Custom Dimensions |
|----------|-------|------------------|-------------------|
| **Gemini** | text-embedding-004 | 768 | 256-768 (e.g., 700) |
| **OpenAI** | text-embedding-ada-002 | 1536 | Fixed |
| **OpenAI** | text-embedding-3-small | 1536 | 256-1536 (e.g., 1583) |
| **OpenAI** | text-embedding-3-large | 3072 | 256-3072 |

### Validation Rules / Regole di Validazione

**English:**
- Minimum dimension: **256**
- Maximum dimension: **4096**
- Any dimension within this range is accepted
- The actual dimension is stored with each vector for tracking

**Italiano:**
- Dimensione minima: **256**
- Dimensione massima: **4096**
- Qualsiasi dimensione all'interno di questo intervallo √® accettata
- La dimensione effettiva viene memorizzata con ogni vettore per il tracciamento

## üîÑ Migration / Migrazione

### EF Core Migration

**English:**
A migration has been created: `AddEmbeddingDimensionTracking`

To apply the migration:
```bash
cd DocN.Server
dotnet ef database update
```

**Italiano:**
√à stata creata una migrazione: `AddEmbeddingDimensionTracking`

Per applicare la migrazione:
```bash
cd DocN.Server
dotnet ef database update
```

### SQL Changes

```sql
-- Add EmbeddingDimension columns
ALTER TABLE Documents 
ADD EmbeddingDimension INT NULL;

ALTER TABLE DocumentChunks
ADD EmbeddingDimension INT NULL;
```

### Backward Compatibility / Compatibilit√† con il Passato

**English:**
- Existing embeddings without dimension information will continue to work
- The `EmbeddingDimension` column is nullable
- When existing embeddings are re-saved, their dimension will be automatically tracked

**Italiano:**
- Gli embedding esistenti senza informazioni sulla dimensione continueranno a funzionare
- La colonna `EmbeddingDimension` √® nullable
- Quando gli embedding esistenti vengono ri-salvati, la loro dimensione verr√† automaticamente tracciata

## üìä How It Works / Come Funziona

### When Saving / Durante il Salvataggio

**English:**
1. AI provider generates embedding (e.g., 700 dimensions from Gemini)
2. `EmbeddingValidationHelper` validates the dimension is within acceptable range
3. Service automatically sets `EmbeddingDimension = embedding.Length`
4. Both the vector and its dimension are saved to the database

**Italiano:**
1. Il provider AI genera l'embedding (es. 700 dimensioni da Gemini)
2. `EmbeddingValidationHelper` valida che la dimensione sia nell'intervallo accettabile
3. Il servizio imposta automaticamente `EmbeddingDimension = embedding.Length`
4. Sia il vettore che la sua dimensione vengono salvati nel database

### When Searching / Durante la Ricerca

**English:**
- Vector search compares vectors using cosine similarity
- The dimension is informational and doesn't affect search
- Vectors of different dimensions can be searched together (though comparing vectors of different dimensions may not be semantically meaningful)

**Italiano:**
- La ricerca vettoriale confronta i vettori usando la similarit√† del coseno
- La dimensione √® informativa e non influisce sulla ricerca
- I vettori di dimensioni diverse possono essere cercati insieme (anche se confrontare vettori di dimensioni diverse potrebbe non essere semanticamente significativo)

## üöÄ Usage Examples / Esempi d'Uso

### Example 1: Gemini with Custom Dimension

```csharp
// Configure Gemini to use 700 dimensions
var config = new GeminiConfiguration
{
    ApiKey = "your-api-key",
    EmbeddingModel = "text-embedding-004"
    // Note: Dimension configuration depends on API/SDK support
};

// Generate embedding (let's say it returns 700 dimensions)
var embedding = await provider.GenerateEmbeddingAsync(text);
// embedding.Length = 700

// Save document - dimension is automatically tracked
document.EmbeddingVector = embedding;
document.EmbeddingDimension = embedding.Length; // Automatically set by service
await context.SaveChangesAsync();
```

### Example 2: OpenAI with Custom Dimension

```csharp
// Configure OpenAI with custom dimension
var config = new OpenAIConfiguration
{
    ApiKey = "your-api-key",
    EmbeddingModel = "text-embedding-3-small"
    // Note: Dimension configuration via API parameters
};

// Generate embedding (let's say it returns 1583 dimensions)
var embedding = await provider.GenerateEmbeddingAsync(text);
// embedding.Length = 1583

// Save document - dimension is automatically tracked
document.EmbeddingVector = embedding;
document.EmbeddingDimension = embedding.Length; // Automatically set by service
await context.SaveChangesAsync();
```

### Example 3: Mixed Dimensions in Same Database

```csharp
// Document 1: Gemini 700 dimensions
var doc1 = new Document
{
    FileName = "file1.pdf",
    EmbeddingVector = geminiEmbedding, // 700 dimensions
    EmbeddingDimension = 700
};

// Document 2: OpenAI 1583 dimensions
var doc2 = new Document
{
    FileName = "file2.pdf",
    EmbeddingVector = openaiEmbedding, // 1583 dimensions
    EmbeddingDimension = 1583
};

// Both can coexist in the same database
context.Documents.AddRange(doc1, doc2);
await context.SaveChangesAsync();
```

## ‚ö†Ô∏è Important Notes / Note Importanti

### Vector Comparison / Confronto Vettori

**English:**
- Comparing vectors of different dimensions may not produce meaningful semantic similarity
- Best practice: Use the same embedding model/dimension for documents you want to compare
- For hybrid deployments, consider organizing documents by embedding dimension

**Italiano:**
- Il confronto di vettori di dimensioni diverse potrebbe non produrre una similarit√† semantica significativa
- Best practice: Utilizzare lo stesso modello/dimensione di embedding per i documenti da confrontare
- Per deployment ibridi, considerare l'organizzazione dei documenti per dimensione di embedding

### Storage Considerations / Considerazioni sullo Storage

**English:**
- Larger dimensions = more storage space
- Larger dimensions = potentially better semantic accuracy
- Balance storage cost vs. accuracy needs for your use case

**Italiano:**
- Dimensioni maggiori = pi√π spazio di archiviazione
- Dimensioni maggiori = potenzialmente migliore accuratezza semantica
- Bilanciare il costo dello storage con le esigenze di accuratezza per il proprio caso d'uso

## üîç Monitoring / Monitoraggio

### Query Dimension Distribution

```sql
-- Check distribution of embedding dimensions in Documents
SELECT 
    EmbeddingDimension,
    COUNT(*) as Count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as Percentage
FROM Documents
WHERE EmbeddingDimension IS NOT NULL
GROUP BY EmbeddingDimension
ORDER BY Count DESC;

-- Check distribution in DocumentChunks
SELECT 
    EmbeddingDimension,
    COUNT(*) as Count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as Percentage
FROM DocumentChunks
WHERE EmbeddingDimension IS NOT NULL
GROUP BY EmbeddingDimension
ORDER BY Count DESC;
```

## üìö References / Riferimenti

- **Gemini Embeddings**: https://ai.google.dev/gemini-api/docs/embeddings
- **OpenAI Embeddings**: https://platform.openai.com/docs/guides/embeddings
- **Matryoshka Embeddings**: Research on flexible embedding dimensions

## üéâ Benefits / Benefici

**English:**
1. ‚úÖ **Flexibility**: Use any AI provider with any dimension
2. ‚úÖ **Coexistence**: Different models can work in the same database
3. ‚úÖ **Future-proof**: New models with new dimensions are automatically supported
4. ‚úÖ **Tracking**: Always know which dimension was used for each vector
5. ‚úÖ **No Migration Needed**: Existing vectors continue to work

**Italiano:**
1. ‚úÖ **Flessibilit√†**: Usare qualsiasi provider AI con qualsiasi dimensione
2. ‚úÖ **Coesistenza**: Modelli diversi possono funzionare nello stesso database
3. ‚úÖ **A prova di futuro**: Nuovi modelli con nuove dimensioni sono automaticamente supportati
4. ‚úÖ **Tracciamento**: Sapere sempre quale dimensione √® stata utilizzata per ogni vettore
5. ‚úÖ **Nessuna Migrazione Necessaria**: I vettori esistenti continuano a funzionare
