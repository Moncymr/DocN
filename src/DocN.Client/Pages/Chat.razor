@page "/chat"
@using MudBlazor

<PageTitle>Chat RAG - DocN</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4" Style="height: calc(100vh - 100px);">
    <MudGrid Style="height: 100%;">
        <!-- Conversations Sidebar -->
        <MudItem xs="12" md="3" Style="height: 100%; overflow-y: auto;">
            <MudCard Elevation="2" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">ðŸ’¬ Conversazioni</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="StartNewConversation" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudList Dense="true">
                        @foreach (var conv in conversations)
                        {
                            <MudListItem Selected="@(conv.Id == selectedConversationId)"
                                         OnClick="@(() => SelectConversation(conv.Id))">
                                <MudText Typo="Typo.body2">@conv.Title</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@conv.LastMessageAt</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Chat Area -->
        <MudItem xs="12" md="9" Style="height: 100%; display: flex; flex-direction: column;">
            <MudCard Elevation="2" Style="flex: 1; display: flex; flex-direction: column;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">ðŸ¤– Chat RAG con Gemini</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Fai domande sui tuoi documenti usando linguaggio naturale
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                
                <!-- Messages -->
                <MudCardContent Style="flex: 1; overflow-y: auto; max-height: calc(100vh - 300px);">
                    @if (!messages.Any())
                    {
                        <MudPaper Elevation="0" Class="d-flex align-center justify-center" Style="height: 100%;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                                <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Large" Color="Color.Primary" />
                                <MudText Typo="Typo.h6" Align="Align.Center">Inizia una nuova conversazione</MudText>
                                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                                    Fai domande sui documenti caricati e ricevi risposte basate sui contenuti
                                </MudText>
                                
                                <!-- Suggested Questions -->
                                <MudText Typo="Typo.body2" Class="mt-4"><strong>Domande suggerite:</strong></MudText>
                                <MudStack Spacing="2">
                                    <MudChip OnClick="@(() => SendSuggestedQuestion("Quali sono i contratti attivi?"))">
                                        Quali sono i contratti attivi?
                                    </MudChip>
                                    <MudChip OnClick="@(() => SendSuggestedQuestion("Mostrami i report finanziari"))">
                                        Mostrami i report finanziari
                                    </MudChip>
                                    <MudChip OnClick="@(() => SendSuggestedQuestion("Cerca documenti sulla sicurezza"))">
                                        Cerca documenti sulla sicurezza
                                    </MudChip>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                    else
                    {
                        <MudStack Spacing="3">
                            @foreach (var message in messages)
                            {
                                <MudPaper Elevation="1" Class="pa-3" 
                                          Style="@(message.IsUser ? "background-color: var(--mud-palette-primary-lighten); margin-left: 20%;" : "background-color: var(--mud-palette-background-grey); margin-right: 20%;")">
                                    <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                        <MudAvatar Color="@(message.IsUser ? Color.Primary : Color.Secondary)" Size="Size.Small">
                                            @(message.IsUser ? "U" : "AI")
                                        </MudAvatar>
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.body1">@message.Content</MudText>
                                            
                                            @if (!message.IsUser && message.ReferencedDocuments.Any())
                                            {
                                                <MudDivider Class="my-2" />
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">ðŸ“š Fonti:</MudText>
                                                <MudStack Row="true" Spacing="1" Class="mt-1">
                                                    @foreach (var doc in message.ReferencedDocuments)
                                                    {
                                                        <MudChip Size="Size.Small" OnClick="@(() => ViewDocument(doc.Id))">
                                                            @doc.Name
                                                        </MudChip>
                                                    }
                                                </MudStack>
                                            }
                                            
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                                @message.Timestamp
                                            </MudText>
                                        </div>
                                    </MudStack>
                                </MudPaper>
                            }
                            
                            @if (isTyping)
                            {
                                <MudPaper Elevation="1" Class="pa-3" Style="background-color: var(--mud-palette-background-grey); margin-right: 20%;">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudAvatar Color="Color.Secondary" Size="Size.Small">AI</MudAvatar>
                                        <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                                        <MudText Typo="Typo.body2">Sto pensando...</MudText>
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }
                </MudCardContent>
                
                <!-- Input Area -->
                <MudCardActions Class="pa-4">
                    <MudTextField T="string" @bind-Value="currentMessage" 
                                  Label="Scrivi un messaggio..." 
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  Lines="2"
                                  Disabled="@isTyping"
                                  OnKeyDown="OnMessageKeyDown"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Send"
                                  AdornmentColor="Color.Primary"
                                  OnAdornmentClick="SendMessage" />
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string currentMessage = "";
    private bool isTyping = false;
    private int? selectedConversationId = null;
    
    private List<ConversationItem> conversations = new();
    private List<MessageItem> messages = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadConversations();
    }
    
    private async Task LoadConversations()
    {
        // TODO: Load from API
        conversations = new List<ConversationItem>();
    }
    
    private async Task StartNewConversation()
    {
        selectedConversationId = null;
        messages.Clear();
        currentMessage = "";
    }
    
    private async Task SelectConversation(int conversationId)
    {
        selectedConversationId = conversationId;
        await LoadMessages(conversationId);
    }
    
    private async Task LoadMessages(int conversationId)
    {
        // TODO: Load messages from API
        messages = new List<MessageItem>();
    }
    
    private async Task OnMessageKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage)) return;
        
        var userMessage = currentMessage;
        currentMessage = "";
        
        // Add user message
        messages.Add(new MessageItem
        {
            Content = userMessage,
            IsUser = true,
            Timestamp = DateTime.Now.ToString("HH:mm")
        });
        
        isTyping = true;
        StateHasChanged();
        
        // TODO: Send to API and get response
        await Task.Delay(2000); // Simulate AI thinking
        
        // Add AI response
        messages.Add(new MessageItem
        {
            Content = "Questa Ã¨ una risposta di esempio. L'integrazione con il sistema RAG verrÃ  implementata nelle prossime fasi.",
            IsUser = false,
            Timestamp = DateTime.Now.ToString("HH:mm"),
            ReferencedDocuments = new List<ReferencedDoc>()
        });
        
        isTyping = false;
        StateHasChanged();
    }
    
    private async Task SendSuggestedQuestion(string question)
    {
        currentMessage = question;
        await SendMessage();
    }
    
    private void ViewDocument(int id)
    {
        // TODO: Navigate to document viewer
    }
    
    private class ConversationItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string LastMessageAt { get; set; } = "";
    }
    
    private class MessageItem
    {
        public string Content { get; set; } = "";
        public bool IsUser { get; set; }
        public string Timestamp { get; set; } = "";
        public List<ReferencedDoc> ReferencedDocuments { get; set; } = new();
    }
    
    private class ReferencedDoc
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }
}
