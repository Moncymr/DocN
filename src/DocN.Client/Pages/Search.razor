@page "/search"
@using MudBlazor

<PageTitle>Ricerca - DocN</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">üîç Ricerca Semantica</MudText>
    
    <MudCard Elevation="2" Class="mb-4">
        <MudCardContent>
            <!-- Search Input -->
            <MudTextField T="string" @bind-Value="searchQuery" 
                          Label="Cerca documenti usando linguaggio naturale" 
                          Variant="Variant.Outlined"
                          Immediate="false"
                          OnKeyDown="OnSearchKeyDown"
                          Adornment="Adornment.End" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          AdornmentColor="Color.Primary"
                          HelperText="Es: Trova contratti del 2024, Cerca policy di sicurezza, Mostra report finanziari"
                          FullWidth="true" />
            
            <!-- Search Options -->
            <MudStack Row="true" Class="mt-3" Spacing="3">
                <MudSwitch @bind-Value="useSemanticSearch" Color="Color.Primary" Label="Ricerca semantica (Gemini)" />
                <MudSwitch @bind-Value="useFullTextSearch" Color="Color.Primary" Label="Full-text search" />
                <MudSlider @bind-Value="similarityThreshold" Min="0.5" Max="1.0" Step="0.05" 
                           Color="Color.Primary">Soglia similarit√†: @similarityThreshold.ToString("F2")</MudSlider>
            </MudStack>
            
            <!-- Filter Section -->
            <MudExpansionPanels Class="mt-3">
                <MudExpansionPanel Text="üîß Filtri Avanzati">
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudSelect T="string" @bind-Value="filterCategory" Label="Categoria" Variant="Variant.Outlined" Multiple="true">
                                <MudSelectItem Value="@("Contratti")">Contratti</MudSelectItem>
                                <MudSelectItem Value="@("Fatture")">Fatture</MudSelectItem>
                                <MudSelectItem Value="@("Report")">Report</MudSelectItem>
                                <MudSelectItem Value="@("Manuali")">Manuali</MudSelectItem>
                                <MudSelectItem Value="@("Policy")">Policy</MudSelectItem>
                                <MudSelectItem Value="@("Corrispondenza")">Corrispondenza</MudSelectItem>
                                <MudSelectItem Value="@("Legale")">Legale</MudSelectItem>
                                <MudSelectItem Value="@("HR")">HR</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudDateRangePicker Label="Periodo" @bind-DateRange="dateRange" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField T="string" @bind-Value="filterTags" Label="Tag" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>
            
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       Class="mt-3"
                       FullWidth="true"
                       OnClick="PerformSearch"
                       Disabled="@isSearching"
                       StartIcon="@Icons.Material.Filled.Search">
                @(isSearching ? "Ricerca in corso..." : "Cerca")
            </MudButton>
        </MudCardContent>
    </MudCard>
    
    <!-- Search Results -->
    @if (searchResults.Any() || isSearching)
    {
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        üìä Risultati (@searchResults.Count)
                        @if (searchTime > 0)
                        {
                            <MudText Typo="Typo.caption" Inline="true" Color="Color.Secondary">
                                - @searchTime ms
                            </MudText>
                        }
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (isSearching)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                }
                else
                {
                    <MudList>
                        @foreach (var result in searchResults)
                        {
                            <MudListItem>
                                <MudCard Outlined="true" Class="mb-2">
                                    <MudCardContent>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                            <div>
                                                <MudText Typo="Typo.h6">
                                                    <MudIcon Icon="@GetFileIcon(result.ContentType)" Size="Size.Small" Class="mr-2" />
                                                    @result.FileName
                                                </MudText>
                                                <MudChip Size="Size.Small" Color="Color.Primary" Class="mr-2">
                                                    @result.Category
                                                </MudChip>
                                                <MudChip Size="Size.Small" Color="Color.Success">
                                                    Similarit√†: @result.Score.ToString("P0")
                                                </MudChip>
                                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                                                    @result.Snippet
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                                    Caricato il @result.UploadedAt
                                                </MudText>
                                            </div>
                                            <MudStack Row="true">
                                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => ViewDocument(result.Id))" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => DownloadDocument(result.Id))" />
                                            </MudStack>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private string searchQuery = "";
    private string filterCategory = "";
    private string filterTags = "";
    private DateRange? dateRange = null;
    private bool useSemanticSearch = true;
    private bool useFullTextSearch = true;
    private double similarityThreshold = 0.7;
    private bool isSearching = false;
    private long searchTime = 0;
    
    private List<SearchResultItem> searchResults = new();
    
    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }
    
    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return;
        
        isSearching = true;
        searchResults.Clear();
        
        var startTime = DateTime.Now;
        
        // TODO: Implement actual search API call
        await Task.Delay(1000); // Simulate search
        
        searchTime = (long)(DateTime.Now - startTime).TotalMilliseconds;
        
        // Placeholder results
        searchResults = new List<SearchResultItem>();
        
        isSearching = false;
    }
    
    private void ViewDocument(int id)
    {
        // TODO: Navigate to document viewer
    }
    
    private async Task DownloadDocument(int id)
    {
        // TODO: Implement download
    }
    
    private string GetFileIcon(string contentType)
    {
        if (contentType.Contains("pdf")) return Icons.Material.Filled.PictureAsPdf;
        if (contentType.Contains("word")) return Icons.Material.Filled.Description;
        if (contentType.Contains("excel")) return Icons.Material.Filled.TableChart;
        if (contentType.Contains("powerpoint")) return Icons.Material.Filled.Slideshow;
        return Icons.Material.Filled.InsertDriveFile;
    }
    
    private class SearchResultItem
    {
        public int Id { get; set; }
        public string FileName { get; set; } = "";
        public string ContentType { get; set; } = "";
        public string Category { get; set; } = "";
        public string Snippet { get; set; } = "";
        public double Score { get; set; }
        public string UploadedAt { get; set; } = "";
    }
}
